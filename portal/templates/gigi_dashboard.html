<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gigi Brain | Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --sidebar-width: 240px;
        --bg-dark: #0f172a;
        --sidebar-bg: #1e293b;
        --card-bg: #1e293b;
        --border-color: #334155;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --accent-blue: #3b82f6;
      }

      body {
        background-color: var(--bg-dark);
        color: var(--text-primary);
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
      }

      /* Layout */
      .wrapper {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: var(--sidebar-width);
        background-color: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
      }

      .sidebar-brand {
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-primary);
        text-decoration: none;
      }

      .nav-menu {
        padding: 20px 0;
        flex-grow: 1;
      }

      .nav-link {
        padding: 12px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.2s;
        font-size: 14px;
        font-weight: 500;
      }

      .nav-link:hover {
        color: var(--text-primary);
        background-color: rgba(255, 255, 255, 0.05);
      }

      .nav-link.active {
        color: white;
        background-color: var(--accent-blue);
      }

      .nav-link i {
        font-size: 18px;
      }

      /* Main Content */
      .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .header {
        padding: 20px 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(8px);
        position: sticky;
        top: 0;
        z-index: 100;
        border-bottom: 1px solid var(--border-color);
      }

      .content-body {
        padding: 32px;
      }

      /* Sub-nav for tabs like Knowledge */
      .sub-nav {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 12px;
      }

      .sub-nav-item {
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        padding-bottom: 12px;
        position: relative;
      }

      .sub-nav-item.active {
        color: var(--accent-blue);
      }

      .sub-nav-item.active::after {
        content: "";
        position: absolute;
        bottom: -13px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--accent-blue);
      }

      /* SOP Markdown View */
      .sop-container {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 40px;
        line-height: 1.6;
        color: #cbd5e1;
      }

      .sop-container h1,
      .sop-container h2,
      .sop-container h3 {
        color: white;
        margin-top: 32px;
        margin-bottom: 16px;
      }

      .sop-container hr {
        border-color: var(--border-color);
        margin: 32px 0;
      }

      .sop-container ul {
        padding-left: 24px;
        margin-bottom: 16px;
      }

      /* Memory Cards */
      .memory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }

      /* Client Tiles */
      .client-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 16px;
      }

      .client-tile {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s;
      }

      .client-tile:hover {
        border-color: var(--accent-blue);
      }

      .client-tile-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .client-tile-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .client-tile-status {
        font-size: 10px;
        text-transform: uppercase;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 4px;
      }

      .client-tile-status.active {
        background: rgba(52, 211, 153, 0.15);
        color: #34d399;
      }

      .client-tile-status.inactive {
        background: rgba(248, 113, 113, 0.15);
        color: #f87171;
      }

      .client-tile-info {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        line-height: 1.6;
      }

      .client-tile-prompt {
        border-top: 1px solid var(--border-color);
        padding-top: 12px;
      }

      .client-tile-prompt label {
        font-size: 11px;
        text-transform: uppercase;
        font-weight: 600;
        color: var(--accent-blue);
        margin-bottom: 6px;
        display: block;
      }

      .client-tile-prompt textarea {
        width: 100%;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        padding: 8px 12px;
        font-size: 13px;
        resize: vertical;
        min-height: 60px;
        transition: border-color 0.2s;
      }

      .client-tile-prompt textarea:focus {
        outline: none;
        border-color: var(--accent-blue);
      }

      .client-tile-prompt textarea::placeholder {
        color: #475569;
      }

      .client-tile-save {
        display: none;
        margin-top: 8px;
        text-align: right;
      }

      .client-tile-save.visible {
        display: block;
      }

      .client-tile.d-none-filter {
        display: none !important;
      }

      .memory-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        transition: transform 0.2s;
      }

      .memory-card:hover {
        transform: translateY(-2px);
        border-color: var(--accent-blue);
      }

      .memory-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .memory-type {
        font-size: 10px;
        text-transform: uppercase;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.05);
      }

      .memory-content {
        font-size: 15px;
        color: #f1f5f9;
        margin-bottom: 16px;
        line-height: 1.5;
      }

      .memory-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 12px;
        color: var(--text-secondary);
        border-top: 1px solid var(--border-color);
        padding-top: 12px;
      }

      .confidence-bar {
        height: 4px;
        background: #334155;
        border-radius: 2px;
        width: 60px;
        overflow: hidden;
      }

      .confidence-fill {
        height: 100%;
        background: var(--accent-blue);
      }

      /* KPI Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
      }

      .stat-label {
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
      }

      /* Table */
      .table-container {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
      }

      .table {
        color: var(--text-primary);
        margin-bottom: 0;
      }

      .table th {
        background-color: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 11px;
        padding: 16px 20px;
      }

      .table td {
        border-bottom: 1px solid var(--border-color);
        padding: 16px 20px;
        vertical-align: middle;
        font-size: 14px;
      }

      .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .priority-high {
        color: #f87171;
      }
      .priority-medium {
        color: #fbbf24;
      }
      .priority-low {
        color: #34d399;
      }

      /* Form Controls */
      .form-control,
      .form-select {
        background-color: #0f172a;
        border: 1px solid var(--border-color);
        color: white;
      }

      .form-control:focus,
      .form-select:focus {
        background-color: #0f172a;
        color: white;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
      }

      .modal-content {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
      }

      .modal-header {
        border-bottom: 1px solid var(--border-color);
      }

      .modal-footer {
        border-top: 1px solid var(--border-color);
      }

      .btn-primary {
        background-color: var(--accent-blue);
        border: none;
        font-weight: 600;
      }

      /* Autocomplete */
      .autocomplete-suggestions {
        position: absolute;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 8px;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .suggestion-item {
        padding: 10px 16px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .suggestion-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <a href="/" class="sidebar-brand">
            <span>ðŸ§  Gigi Brain</span>
          </a>
        </div>
        <nav class="nav-menu">
          <a
            href="/gigi/dashboard/issues"
            class="nav-link {{ 'active' if active_tab == 'issues' }}"
          >
            <i class="bi bi-exclamation-circle"></i>
            <span>Issues</span>
          </a>
          <a
            href="/gigi/dashboard/schedule"
            class="nav-link {{ 'active' if active_tab == 'schedule' }}"
          >
            <i class="bi bi-calendar3"></i>
            <span>Schedule</span>
          </a>
          <a
            href="/gigi/dashboard/knowledge"
            class="nav-link {{ 'active' if active_tab == 'knowledge' }}"
          >
            <i class="bi bi-book"></i>
            <span>Knowledge</span>
          </a>
          <a
            href="/gigi/dashboard/escalations"
            class="nav-link {{ 'active' if active_tab == 'escalations' }}"
          >
            <i class="bi bi-arrow-up-right-circle"></i>
            <span>Escalations</span>
          </a>
          <a
            href="/gigi/dashboard/users"
            class="nav-link {{ 'active' if active_tab == 'users' }}"
          >
            <i class="bi bi-people"></i>
            <span>Users</span>
          </a>
          <a
            href="/gigi/dashboard/reports"
            class="nav-link {{ 'active' if active_tab == 'reports' }}"
          >
            <i class="bi bi-graph-up"></i>
            <span>Reports</span>
          </a>
          <a
            href="/gigi/dashboard/communications"
            class="nav-link {{ 'active' if active_tab == 'communications' }}"
          >
            <i class="bi bi-chat-dots"></i>
            <span>Communications</span>
          </a>
          <a
            href="/gigi/dashboard/simulations"
            class="nav-link {{ 'active' if active_tab == 'simulations' }}"
          >
            <i class="bi bi-cpu"></i>
            <span>Simulations</span>
          </a>
          <a
            href="/gigi/dashboard/settings"
            class="nav-link {{ 'active' if active_tab == 'settings' }}"
          >
            <i class="bi bi-gear"></i>
            <span>Settings</span>
          </a>
          <a
            href="/gigi/dashboard/learning"
            class="nav-link {{ 'active' if active_tab == 'learning' }}"
          >
            <i class="bi bi-mortarboard"></i>
            <span>Learning</span>
          </a>
        </nav>
        <div class="p-4 mt-auto">
          <div class="d-flex align-items-center gap-3">
            <div
              class="bg-primary rounded-circle"
              style="
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
              "
            >
              J
            </div>
            <div class="small">
              <div class="fw-bold">Jason Shulman</div>
              <div class="text-secondary">Owner</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main -->
      <div class="main-content">
        <header class="header">
          <div class="d-flex align-items-center gap-3">
            <a
              href="/"
              style="
                color: #94a3b8;
                text-decoration: none;
                font-size: 14px;
                white-space: nowrap;
              "
              >&larr; Portal</a
            >
            <h2 class="mb-0 fw-bold">
              {% if active_tab == 'issues' %}Issues {% elif active_tab ==
              'schedule' %}Schedule {% elif active_tab == 'knowledge'
              %}Knowledge Base {% elif active_tab == 'escalations' %}Escalations
              {% elif active_tab == 'users' %}User Management {% elif active_tab
              == 'reports' %}Analytics & Reports {% elif active_tab ==
              'communications' %}Communications {% elif active_tab ==
              'simulations' %}Simulations & Testing {% elif active_tab ==
              'settings' %}Settings {% elif active_tab == 'learning' %}Learning
              & Evaluation {% else %}{{ active_tab|capitalize }}{% endif %}
            </h2>
          </div>
          <div class="d-flex gap-3">
            {% if active_tab == 'issues' %}
            <button class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-download"></i> Export
            </button>
            <button
              class="btn btn-primary btn-sm"
              onclick="showCreateIssueModal()"
            >
              <i class="bi bi-plus-lg"></i> Create Issue
            </button>
            {% elif active_tab == 'simulations' %}
            <button class="btn btn-primary btn-sm" onclick="runNewSimulation()">
              <i class="bi bi-play-fill"></i> Run New Test
            </button>
            {% endif %}
          </div>
        </header>

        <div class="content-body">
          {% if active_tab == 'issues' %}
          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Issues</div>
              <div class="stat-value" id="stat-total">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Urgent / High</div>
              <div class="stat-value text-danger" id="stat-urgent">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">In Progress</div>
              <div class="stat-value text-warning" id="stat-progress">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Resolved Today</div>
              <div class="stat-value text-success" id="stat-resolved">-</div>
            </div>
          </div>

          <!-- Table -->
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Client</th>
                  <th>Caregiver</th>
                  <th>Type</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Reported</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="issues-table-body">
                <tr>
                  <td colspan="8" class="text-center py-5">
                    <div
                      class="spinner-border text-primary spinner-border-sm"
                      role="status"
                    ></div>
                    <span class="ms-2 text-secondary">Loading issues...</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          {% elif active_tab == 'schedule' %}
          <!-- Schedule KPIs -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Today's Visits</div>
              <div class="stat-value" id="stat-sched-total">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Unassigned</div>
              <div class="stat-value text-danger" id="stat-sched-open">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">In Progress</div>
              <div class="stat-value text-info" id="stat-sched-progress">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Completed</div>
              <div class="stat-value text-success" id="stat-sched-done">-</div>
            </div>
          </div>

          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Client</th>
                  <th>Caregiver</th>
                  <th>Time</th>
                  <th>Duration</th>
                  <th>Location</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="schedule-table-body">
                <tr>
                  <td colspan="7" class="text-center py-5">
                    <div
                      class="spinner-border text-primary spinner-border-sm"
                      role="status"
                    ></div>
                    <span class="ms-2 text-secondary">Loading schedule...</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          {% elif active_tab == 'escalations' %}
          <div class="row g-4">
            <div class="col-md-7">
              <h5 class="mb-3 text-secondary small fw-bold uppercase">
                Critical Escalations
              </h5>
              <div class="table-container mb-4">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Issue</th>
                      <th>Client</th>
                      <th>Reported</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="escalations-table-body">
                    <!-- Escalations loaded here -->
                  </tbody>
                </table>
              </div>

              <h5 class="mb-3 text-secondary small fw-bold uppercase">
                Gigi Activity Log (QA)
              </h5>
              <div class="table-container">
                <div id="bot-activity-list" class="p-0">
                  <!-- Bot activity loaded here -->
                </div>
              </div>
            </div>
            <div class="col-md-5">
              <h5 class="mb-3 text-secondary small fw-bold uppercase">
                Voice Call Log
              </h5>
              <div id="voice-log-list" class="d-flex flex-column gap-3">
                <!-- Voice logs loaded here -->
              </div>
            </div>
          </div>
          {% elif active_tab == 'knowledge' %}
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="sub-nav mb-0 border-0 pb-0">
              <div
                class="sub-nav-item active"
                id="subnav-sop"
                onclick="switchKnowledge('sop')"
              >
                SOPs (Knowledge Base)
              </div>
              <div
                class="sub-nav-item"
                id="subnav-clients"
                onclick="switchKnowledge('clients')"
              >
                Clients
              </div>
              <div
                class="sub-nav-item"
                id="subnav-memories"
                onclick="switchKnowledge('memories')"
              >
                Long-Term Memories
              </div>
            </div>
            <div id="sop-actions">
              <button
                class="btn btn-outline-info btn-sm"
                id="btn-edit-sop"
                onclick="enableSOPEdit()"
              >
                <i class="bi bi-pencil-square"></i> Edit SOP
              </button>
              <div id="sop-edit-buttons" class="d-none">
                <button
                  class="btn btn-link text-secondary text-decoration-none btn-sm"
                  onclick="cancelSOPEdit()"
                >
                  Cancel
                </button>
                <button class="btn btn-primary btn-sm" onclick="saveSOP()">
                  <i class="bi bi-check-lg"></i> Save Changes
                </button>
              </div>
            </div>
          </div>

          <!-- SOP View -->
          <div id="view-sop" class="sop-container">
            <div class="text-center py-5">
              <div
                class="spinner-border text-primary spinner-border-sm"
                role="status"
              ></div>
              <span class="ms-2 text-secondary">Loading Knowledge Base...</span>
            </div>
          </div>

          <!-- SOP Edit -->
          <div id="edit-sop" class="d-none">
            <textarea
              class="form-control bg-dark text-white font-monospace"
              id="sop-textarea"
              rows="25"
              style="
                font-family: &quot;Courier New&quot;, Courier, monospace;
                font-size: 14px;
                line-height: 1.5;
              "
            ></textarea>
          </div>

          <!-- Memories View -->
          <div id="view-memories" class="d-none">
            <div class="memory-grid" id="memory-grid">
              <!-- Memories loaded here -->
            </div>
          </div>

          <!-- Clients View -->
          <div id="view-clients" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="text-secondary small">
                Client-specific prompts help Gigi handle each client's unique
                needs. Data synced from WellSky every 2 hours.
              </div>
              <div class="d-flex align-items-center gap-2">
                <input
                  type="text"
                  class="form-control form-control-sm bg-dark text-white"
                  id="client-search"
                  placeholder="Search clients..."
                  style="width: 200px; border-color: var(--border-color)"
                  oninput="filterClients(this.value)"
                />
              </div>
            </div>
            <div class="client-grid" id="client-grid">
              <div class="text-center py-5 w-100 text-secondary">
                Loading clients...
              </div>
            </div>
          </div>
          {% elif active_tab == 'users' %}
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Last Active</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <!-- Users loaded here -->
              </tbody>
            </table>
          </div>
          {% elif active_tab == 'reports' %}
          <div class="row g-4 mb-4">
            <div class="col-md-3">
              <div class="stat-card text-center">
                <div class="stat-label">Total Interactions</div>
                <div class="stat-value" id="report-total-interactions">
                  &mdash;
                </div>
                <div class="text-secondary" style="font-size: 11px">
                  Last 30 days
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card text-center">
                <div class="stat-label">Unique Contacts</div>
                <div class="stat-value" id="report-unique-contacts">
                  &mdash;
                </div>
                <div class="text-secondary" style="font-size: 11px">
                  Last 30 days
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card text-center">
                <div class="stat-label">Messages</div>
                <div class="stat-value text-info" id="report-total-messages">
                  &mdash;
                </div>
                <div class="text-secondary" style="font-size: 11px">
                  Last 30 days
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card text-center">
                <div class="stat-label">Escalations</div>
                <div class="stat-value text-warning" id="report-escalations">
                  &mdash;
                </div>
                <div class="text-secondary" style="font-size: 11px">
                  Last 30 days
                </div>
              </div>
            </div>
          </div>

          <div class="row g-4">
            <div class="col-md-6">
              <div class="stat-card" style="min-height: 300px">
                <h6 class="text-secondary small fw-bold uppercase mb-4">
                  Message Volume (Last 7 Days)
                </h6>
                <div
                  id="report-daily-bars"
                  class="d-flex align-items-end justify-content-between px-2"
                  style="height: 200px"
                >
                  <div class="text-center text-secondary small py-5 w-100">
                    Loading...
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="stat-card" style="min-height: 300px">
                <h6 class="text-secondary small fw-bold uppercase mb-4">
                  Channel Distribution
                </h6>
                <ul id="report-channel-dist" class="list-unstyled">
                  <li class="text-center text-secondary small py-5">
                    Loading...
                  </li>
                </ul>
              </div>
            </div>
          </div>
          {% elif active_tab == 'communications' %}
          <!-- Channel filter bar -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex gap-2 align-items-center">
              <select
                id="comm-channel-filter"
                onchange="loadCommunications()"
                class="form-select form-select-sm"
                style="
                  width: auto;
                  background: var(--bg-secondary);
                  color: var(--text-primary);
                  border-color: var(--border-color);
                "
              >
                <option value="">All Channels</option>
                <option value="voice">Voice Calls</option>
                <option value="sms">SMS</option>
                <option value="dm">RC Direct Messages</option>
                <option value="team_chat">RC Team Chat</option>
                <option value="telegram">Telegram</option>
                <option value="api">Ask Gigi API</option>
              </select>
              <span class="text-secondary small" id="comm-count-label"></span>
            </div>
            <div class="d-flex gap-2">
              <span
                id="comm-stats-reviewed"
                class="badge"
                style="
                  background: var(--bg-tertiary);
                  color: var(--text-secondary);
                "
              ></span>
              <span
                id="comm-stats-good"
                class="badge"
                style="
                  background: rgba(16, 185, 129, 0.15);
                  color: var(--accent-green);
                "
              ></span>
              <span
                id="comm-stats-improve"
                class="badge"
                style="background: rgba(245, 158, 11, 0.15); color: #f59e0b"
              ></span>
            </div>
          </div>

          <!-- Communication list -->
          <div id="comm-list-container" class="table-container">
            <div class="text-center py-5">
              <div
                class="spinner-border text-primary spinner-border-sm"
                role="status"
              ></div>
              <span class="ms-2 text-secondary">Loading communications...</span>
            </div>
          </div>

          <!-- Interaction Detail Modal -->
          <div
            class="modal fade"
            id="interactionDetailModal"
            tabindex="-1"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div
                class="modal-content"
                style="
                  background: var(--bg-secondary);
                  border: 1px solid var(--border-color);
                "
              >
                <div
                  class="modal-header"
                  style="border-bottom-color: var(--border-color)"
                >
                  <h5 class="modal-title" style="color: var(--text-primary)">
                    <span id="detail-channel-badge" class="badge me-2"></span>
                    <span id="detail-user-id"></span>
                  </h5>
                  <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                  ></button>
                </div>
                <div
                  class="modal-body"
                  style="max-height: 400px; overflow-y: auto"
                >
                  <div
                    id="detail-audio-player"
                    style="display: none; margin-bottom: 12px"
                  >
                    <audio
                      controls
                      style="width: 100%"
                      id="detail-audio-el"
                    ></audio>
                  </div>
                  <div
                    id="detail-messages"
                    style="font-size: 13px; line-height: 1.7"
                  ></div>
                </div>
                <div
                  class="modal-footer flex-column align-items-stretch"
                  style="border-top-color: var(--border-color)"
                >
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <span style="color: var(--text-secondary); font-size: 13px"
                      >Rate this response:</span
                    >
                    <div class="d-flex gap-2" id="feedback-buttons">
                      <button
                        class="btn btn-sm"
                        onclick="submitFeedback('good')"
                        style="
                          background: rgba(16, 185, 129, 0.15);
                          color: var(--accent-green);
                          border: 1px solid rgba(16, 185, 129, 0.3);
                        "
                      >
                        <i class="bi bi-hand-thumbs-up-fill"></i> Good Response
                      </button>
                      <button
                        class="btn btn-sm"
                        onclick="showImprovementInput()"
                        style="
                          background: rgba(245, 158, 11, 0.15);
                          color: #f59e0b;
                          border: 1px solid rgba(245, 158, 11, 0.3);
                        "
                      >
                        <i class="bi bi-hand-thumbs-down-fill"></i> Needs
                        Improvement
                      </button>
                    </div>
                  </div>
                  <div id="improvement-input" style="display: none">
                    <textarea
                      id="improvement-notes"
                      class="form-control form-control-sm mb-2"
                      rows="3"
                      placeholder="How should Gigi improve? Be specific..."
                      style="
                        background: var(--bg-tertiary);
                        color: var(--text-primary);
                        border-color: var(--border-color);
                      "
                    ></textarea>
                    <button
                      class="btn btn-sm btn-warning w-100"
                      onclick="submitFeedback('needs_improvement')"
                    >
                      Submit Correction
                    </button>
                  </div>
                  <div
                    id="feedback-result"
                    style="display: none"
                    class="text-center py-2"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          {% elif active_tab == 'simulations' %}
          <!-- Sub-nav for Scenarios vs History -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="sub-nav mb-0 border-0 pb-0">
              <div
                class="sub-nav-item active"
                id="subnav-scenarios"
                onclick="switchSimulations('scenarios')"
              >
                Test Scenarios
              </div>
              <div
                class="sub-nav-item"
                id="subnav-history"
                onclick="switchSimulations('history')"
              >
                Test History
              </div>
              <div
                class="sub-nav-item"
                id="subnav-calls"
                onclick="switchSimulations('calls')"
              >
                Call History
              </div>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <div class="d-flex align-items-center gap-2">
                <label class="text-secondary small mb-0 text-nowrap"
                  >Voice Model:</label
                >
                <select
                  class="form-select form-select-sm"
                  id="voice-model-select"
                  style="width: auto; min-width: 220px"
                  onchange="setVoiceModel()"
                >
                  <option value="default">Default (env)</option>
                  <optgroup label="MiniMax">
                    <option value="minimax|MiniMax-M2.5">MiniMax M2.5</option>
                    <option value="minimax|MiniMax-M2.1">MiniMax M2.1</option>
                  </optgroup>
                  <optgroup label="Gemini">
                    <option value="gemini|gemini-2.5-flash-preview-05-20">
                      Gemini 2.5 Flash
                    </option>
                    <option value="gemini|gemini-2.5-pro-preview-05-06">
                      Gemini 2.5 Pro
                    </option>
                    <option value="gemini|gemini-2.0-flash">
                      Gemini 2.0 Flash
                    </option>
                  </optgroup>
                  <optgroup label="DeepSeek">
                    <option value="deepseek|deepseek-chat">DeepSeek V3</option>
                    <option value="deepseek|deepseek-reasoner">
                      DeepSeek R1
                    </option>
                  </optgroup>
                  <optgroup label="Kimi (Moonshot)">
                    <option value="kimi|moonshot-v1-128k">
                      Kimi Moonshot 128K
                    </option>
                    <option value="kimi|moonshot-v1-32k">
                      Kimi Moonshot 32K
                    </option>
                    <option value="kimi|moonshot-v1-8k">
                      Kimi Moonshot 8K
                    </option>
                  </optgroup>
                  <optgroup label="Anthropic">
                    <option value="anthropic|claude-haiku-4-5-20251001">
                      Claude Haiku 4.5
                    </option>
                    <option value="anthropic|claude-sonnet-4-20250514">
                      Claude Sonnet 4
                    </option>
                  </optgroup>
                </select>
                <span
                  id="voice-model-status"
                  class="badge bg-secondary bg-opacity-25 text-secondary small"
                ></span>
              </div>
              <a
                href="https://app.retellai.com"
                target="_blank"
                class="btn btn-outline-secondary btn-sm"
              >
                <i class="bi bi-box-arrow-up-right"></i> Retell
              </a>
            </div>
          </div>

          <!-- Scenarios View -->
          <div id="view-scenarios">
            <div class="row g-3" id="scenarios-grid">
              <div class="text-center py-5">
                <div
                  class="spinner-border text-primary spinner-border-sm"
                  role="status"
                ></div>
                <span class="ms-2 text-secondary"
                  >Loading test scenarios...</span
                >
              </div>
            </div>
          </div>

          <!-- History View -->
          <div id="view-history" class="d-none">
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Scenario</th>
                    <th>Status</th>
                    <th class="text-center">Turns</th>
                    <th class="text-center">Score</th>
                    <th class="text-center">Duration</th>
                    <th>Time</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="history-table-body">
                  <tr>
                    <td colspan="8" class="text-center py-5">
                      <div
                        class="spinner-border text-primary spinner-border-sm"
                        role="status"
                      ></div>
                      <span class="ms-2 text-secondary"
                        >Loading simulations...</span
                      >
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Call History View (Retell) -->
          <div id="view-calls" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-secondary small"
                >Real phone & web calls from Retell</span
              >
              <button
                class="btn btn-outline-secondary btn-sm"
                onclick="loadCallHistory()"
              >
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Caller</th>
                    <th class="text-center">Duration</th>
                    <th class="text-center">Tools</th>
                    <th>Summary</th>
                    <th>Time</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="calls-table-body">
                  <tr>
                    <td colspan="7" class="text-center py-5">
                      <div
                        class="spinner-border text-primary spinner-border-sm"
                        role="status"
                      ></div>
                      <span class="ms-2 text-secondary"
                        >Loading call history...</span
                      >
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Call Detail Modal -->
          <div class="modal fade" id="callDetailModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title fw-bold" id="callDetailTitle">
                    Call Details
                  </h5>
                  <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                  ></button>
                </div>
                <div class="modal-body" id="simulationDetailBody">
                  <!-- Populated dynamically by viewSimulationDetails / viewCallDetails -->
                </div>
                <div class="modal-footer">
                  <a
                    href="#"
                    id="recordingLink"
                    target="_blank"
                    class="btn btn-outline-info d-none"
                  >
                    <i class="bi bi-play-fill"></i> Listen to Recording
                  </a>
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-dismiss="modal"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% elif active_tab == 'settings' %}
          <div
            class="card bg-dark border-secondary border-opacity-25 shadow-lg"
          >
            <div class="card-body p-4">
              <div
                class="d-flex justify-content-between align-items-center mb-4"
              >
                <h5 class="mb-0">ðŸ§  Gigi System Configuration</h5>
                <span
                  class="badge bg-success bg-opacity-10 text-success px-3 py-2"
                  >LIVE AGENT</span
                >
              </div>
              <form id="settings-form">
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="mb-4">
                      <label class="form-label text-secondary small fw-bold"
                        >OPERATING MODE</label
                      >
                      <select class="form-select" id="setting-mode">
                        <option value="always">Always Active (24/7)</option>
                        <option value="after_hours">After Hours Only</option>
                        <option value="shadow">Shadow Mode (Testing)</option>
                        <option value="disabled">
                          Disabled (Monitoring Only)
                        </option>
                      </select>
                      <div class="form-text text-secondary small">
                        Controls when Gigi answers incoming calls.
                      </div>
                    </div>
                    <div class="mb-4">
                      <label class="form-label text-secondary small fw-bold"
                        >OFFICE HOURS (MT)</label
                      >
                      <div class="d-flex gap-2 align-items-center">
                        <input
                          type="time"
                          class="form-control"
                          id="setting-hours-start"
                          value="08:00"
                        />
                        <span class="text-secondary">to</span>
                        <input
                          type="time"
                          class="form-control"
                          id="setting-hours-end"
                          value="17:00"
                        />
                      </div>
                      <div class="form-text text-secondary small">
                        Payroll/billing questions outside these hours get
                        callback promise.
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-4">
                      <label class="form-label text-secondary small fw-bold"
                        >TRANSFER DESTINATION</label
                      >
                      <input
                        type="tel"
                        class="form-control"
                        id="setting-transfer-phone"
                        value="+16039971495"
                      />
                      <div class="form-text text-secondary small">
                        Calls requiring human handoff go here (Jason).
                      </div>
                    </div>
                    <div class="mb-4">
                      <label class="form-label text-secondary small fw-bold"
                        >SIMULATION CALLER MODEL</label
                      >
                      <select class="form-select" id="setting-sim-model">
                        <option value="claude-sonnet-4-20250514" selected>
                          Claude Sonnet 4 (Recommended)
                        </option>
                        <option value="claude-haiku-4-5-20251001">
                          Claude Haiku 4.5
                        </option>
                        <option value="gemini-2.5-flash">
                          Gemini 2.5 Flash
                        </option>
                      </select>
                      <div class="form-text text-secondary small">
                        LLM that plays the simulated caller in voice tests.
                      </div>
                    </div>
                    <div class="mb-4">
                      <label class="form-label text-secondary small fw-bold"
                        >LOGGING VERBOSITY</label
                      >
                      <select class="form-select" id="setting-log-level">
                        <option value="standard">
                          Standard (Escalations Only)
                        </option>
                        <option value="detailed" selected>
                          Detailed (All Interactions)
                        </option>
                        <option value="debug">Debug (Developer Mode)</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-12">
                    <hr class="border-secondary border-opacity-25 my-4" />
                    <div class="form-check form-switch mb-3">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="setting-wellsky-sync"
                        checked
                      />
                      <label class="form-check-label fw-bold small"
                        >REAL-TIME WELLSKY SYNC</label
                      >
                      <div class="form-text text-secondary small">
                        Automatically create notes and tasks in WellSky.
                      </div>
                    </div>
                    <div class="form-check form-switch mb-4">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="setting-auto-sms"
                        checked
                      />
                      <label class="form-check-label fw-bold small"
                        >AUTOMATIC SMS REPLIER</label
                      >
                      <div class="form-text text-secondary small">
                        Allow Gigi to respond to missed RingCentral messages.
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-4 d-flex gap-3">
                  <button
                    type="button"
                    class="btn btn-primary px-5"
                    onclick="saveSettings()"
                  >
                    Save Changes
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-danger"
                    onclick="resetGigi()"
                  >
                    Restart Agent
                  </button>
                </div>
              </form>
            </div>
          </div>
          {% elif active_tab == 'learning' %}
          <!-- Scorecard -->
          <div class="row g-4 mb-4" id="eval-scorecard">
            <div class="col-md-3">
              <div class="card bg-dark border-secondary border-opacity-25">
                <div class="card-body text-center">
                  <h6 class="text-secondary mb-1">Telegram</h6>
                  <h2 class="mb-0 fw-bold" id="score-telegram">&mdash;</h2>
                  <small class="text-secondary"
                    ><span id="count-telegram">0</span> evaluated</small
                  >
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-dark border-secondary border-opacity-25">
                <div class="card-body text-center">
                  <h6 class="text-secondary mb-1">SMS</h6>
                  <h2 class="mb-0 fw-bold" id="score-sms">&mdash;</h2>
                  <small class="text-secondary"
                    ><span id="count-sms">0</span> evaluated</small
                  >
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-dark border-secondary border-opacity-25">
                <div class="card-body text-center">
                  <h6 class="text-secondary mb-1">Voice</h6>
                  <h2 class="mb-0 fw-bold" id="score-voice">&mdash;</h2>
                  <small class="text-secondary"
                    ><span id="count-voice">0</span> evaluated</small
                  >
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-dark border-secondary border-opacity-25">
                <div class="card-body text-center">
                  <h6 class="text-secondary mb-1">DM</h6>
                  <h2 class="mb-0 fw-bold" id="score-dm">&mdash;</h2>
                  <small class="text-secondary"
                    ><span id="count-dm">0</span> evaluated</small
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Flagged Responses -->
          <div class="card bg-dark border-secondary border-opacity-25 mb-4">
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h5 class="mb-0">Flagged Responses</h5>
                <span
                  class="badge bg-danger bg-opacity-10 text-danger"
                  id="flagged-count-badge"
                  >0 flagged</span
                >
              </div>
              <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Channel</th>
                      <th>User Message</th>
                      <th>Score</th>
                      <th>Reason</th>
                    </tr>
                  </thead>
                  <tbody id="flagged-table-body">
                    <tr>
                      <td colspan="5" class="text-center py-4 text-secondary">
                        Loading...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- SMS Learning Stats -->
          <div class="card bg-dark border-secondary border-opacity-25">
            <div class="card-body">
              <h5 class="mb-3">SMS Shadow Learning</h5>
              <div class="row g-3">
                <div class="col text-center">
                  <div class="fs-4 fw-bold" id="sms-total-drafts">&mdash;</div>
                  <small class="text-secondary">Total Drafts</small>
                </div>
                <div class="col text-center">
                  <div class="fs-4 fw-bold" id="sms-paired">&mdash;</div>
                  <small class="text-secondary">Paired</small>
                </div>
                <div class="col text-center">
                  <div class="fs-4 fw-bold" id="sms-corrections">&mdash;</div>
                  <small class="text-secondary">Corrections</small>
                </div>
                <div class="col text-center">
                  <div class="fs-4 fw-bold" id="sms-avg-diff">&mdash;</div>
                  <small class="text-secondary">Avg Diff Score</small>
                </div>
                <div class="col text-center">
                  <div class="fs-4 fw-bold" id="sms-active-memories">
                    &mdash;
                  </div>
                  <small class="text-secondary">Active Memories</small>
                </div>
              </div>
            </div>
          </div>

          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-tools fs-1 text-secondary opacity-25"></i>
            <h4 class="mt-3 text-secondary">Tab Under Construction</h4>
            <p class="text-secondary small">
              This feature is being replicated from Gigi.
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Create Issue Modal -->
    <div class="modal fade" id="createIssueModal" tabindex="-1">
      <div class="modal-content modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Create New Issue</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <form id="createIssueForm">
            <div class="row g-3">
              <div class="col-md-6 position-relative">
                <label class="form-label text-secondary small fw-bold"
                  >CLIENT *</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="clientSearch"
                  placeholder="Search Client..."
                  required
                  autocomplete="off"
                />
                <input type="hidden" id="selectedClientId" />
                <div
                  id="clientSuggestions"
                  class="autocomplete-suggestions d-none"
                ></div>
              </div>
              <div class="col-md-6 position-relative">
                <label class="form-label text-secondary small fw-bold"
                  >RELATED SHIFT</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="shiftSearch"
                  placeholder="Search Shift..."
                  autocomplete="off"
                />
                <input type="hidden" id="selectedShiftId" />
                <div
                  id="shiftSuggestions"
                  class="autocomplete-suggestions d-none"
                ></div>
              </div>
              <div class="col-md-6 position-relative">
                <label class="form-label text-secondary small fw-bold"
                  >CAREGIVER</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="caregiverSearch"
                  placeholder="Search Caregiver..."
                  autocomplete="off"
                />
                <input type="hidden" id="selectedCaregiverId" />
                <div
                  id="caregiverSuggestions"
                  class="autocomplete-suggestions d-none"
                ></div>
              </div>
              <div class="col-md-4">
                <label class="form-label text-secondary small fw-bold"
                  >ISSUE TYPE</label
                >
                <select class="form-select" id="issueType">
                  <option value="callout">Call-out</option>
                  <option value="late">Running Late</option>
                  <option value="complaint" selected>Complaint</option>
                  <option value="scheduling">Scheduling Request</option>
                  <option value="medication">Medication Issue</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label text-secondary small fw-bold"
                  >PRIORITY</label
                >
                <select class="form-select" id="issuePriority">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical / Urgent</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label text-secondary small fw-bold"
                  >INITIAL STATUS</label
                >
                <select class="form-select" id="issueStatus">
                  <option value="open" selected>Open</option>
                  <option value="in_progress">In Progress</option>
                  <option value="review">Needs Review</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label text-secondary small fw-bold"
                  >DESCRIPTION *</label
                >
                <textarea
                  class="form-control"
                  id="issueDescription"
                  rows="4"
                  placeholder="Describe the issue in detail..."
                  required
                ></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-link text-secondary text-decoration-none"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary px-4"
            onclick="saveIssue()"
          >
            Create Issue
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
            let createModal;
            const activeTab = "{{ active_tab }}";

            document.addEventListener("DOMContentLoaded", () => {
              createModal = new bootstrap.Modal(
                document.getElementById("createIssueModal"),
              );

              if (activeTab === "issues") {
                loadIssues();
                setupAutocompletes();
              } else if (activeTab === "knowledge") {
                loadSOP();
              } else if (activeTab === "schedule") {
                loadSchedule();
              } else if (activeTab === "escalations") {
                loadEscalations();
              } else if (activeTab === "communications") {
                loadCommunications();
                loadCommStats();
              } else if (activeTab === "users") {
                loadUsers();
              } else if (activeTab === "simulations") {
                loadScenarios();
                loadCurrentVoiceModel();
              } else if (activeTab === "reports") {
                loadReports();
              }
            });

            async function loadUsers() {
              try {
                const resp = await fetch("/api/gigi/users");
                const data = await resp.json();
                if (data.success) {
                  const html = data.users
                    .map(
                      (u) => `
                              <tr>
                                  <td class="fw-bold">${u.name} <br><small class="text-secondary fw-normal">${u.email}</small></td>
                                  <td>Manager</td>
                                  <td><span class="status-badge ${u.status === "Active" ? "bg-success" : "bg-secondary"} bg-opacity-10">${u.status}</span></td>
                                  <td>${new Date(u.last_active).toLocaleString()}</td>
                                  <td class="text-end"><button class="btn btn-link text-secondary p-0"><i class="bi bi-three-dots-vertical"></i></button></td>
                              </tr>
                          `,
                    )
                    .join("");
                  document.getElementById("users-table-body").innerHTML = html;
                }
              } catch (err) {
                console.error(err);
              }
            }

            async function loadReports() {
              try {
                const resp = await fetch("/api/gigi/reports");
                const data = await resp.json();
                if (data.success) {
                  const s = data.stats;
                  document.getElementById("report-total-interactions").textContent =
                    s.total_interactions.toLocaleString();
                  document.getElementById("report-unique-contacts").textContent =
                    s.unique_contacts.toLocaleString();
                  document.getElementById("report-total-messages").textContent =
                    s.total_messages.toLocaleString();
                  document.getElementById("report-escalations").textContent =
                    s.escalations;

                  // Update daily volume bars
                  const maxVol = Math.max(...s.daily_volume.map((d) => d.count), 1);
                  const barsHtml = s.daily_volume
                    .map((d) => {
                      const pct = Math.round((d.count / maxVol) * 100);
                      const dayName = new Date(
                        d.date + "T12:00:00",
                      ).toLocaleDateString("en-US", { weekday: "short" });
                      return `<div class="text-center flex-fill">
                                  <div class="bg-primary mx-1" style="height: ${pct}%; min-height: 4px; border-radius: 4px 4px 0 0;"></div>
                                  <div class="text-secondary small mt-1">${dayName}</div>
                                  <div class="text-secondary" style="font-size:11px">${d.count}</div>
                              </div>`;
                    })
                    .join("");
                  document.getElementById("report-daily-bars").innerHTML = barsHtml;

                  // Update channel distribution
                  const channels = s.by_channel;
                  const totalCh =
                    Object.values(channels).reduce((a, b) => a + b, 0) || 1;
                  const colors = {
                    sms: "bg-primary",
                    voice: "bg-info",
                    telegram: "bg-success",
                    dm: "bg-warning",
                    api: "bg-secondary",
                  };
                  const labels = {
                    sms: "SMS",
                    voice: "Voice",
                    telegram: "Telegram",
                    dm: "Direct Messages",
                    api: "Ask Gigi API",
                  };
                  const distHtml = Object.entries(channels)
                    .sort((a, b) => b[1] - a[1])
                    .map(([ch, cnt]) => {
                      const pct = Math.round((cnt / totalCh) * 100);
                      return `<li class="mb-3">
                                      <div class="d-flex justify-content-between small mb-1">
                                          <span>${labels[ch] || ch}</span><span>${pct}% (${cnt})</span>
                                      </div>
                                      <div class="progress" style="height: 6px; background: #0f172a;">
                                          <div class="progress-bar ${colors[ch] || "bg-primary"}" style="width: ${pct}%"></div>
                                      </div>
                                  </li>`;
                    })
                    .join("");
                  document.getElementById("report-channel-dist").innerHTML = distHtml;
                }
              } catch (err) {
                console.error("Failed to load reports", err);
              }
            }

            let currentInteractionId = null;
            let currentInteractionType = null;
            let currentUserMessage = "";
            let currentGigiResponse = "";
            let currentUserIdentifier = "";
            let detailModal = null;

            const channelColors = {
              voice: { bg: "rgba(99,102,241,0.15)", text: "#818cf8", label: "Voice" },
              sms: { bg: "rgba(16,185,129,0.15)", text: "#10b981", label: "SMS" },
              dm: { bg: "rgba(59,130,246,0.15)", text: "#3b82f6", label: "DM" },
              team_chat: {
                bg: "rgba(168,85,247,0.15)",
                text: "#a855f7",
                label: "Team Chat",
              },
              telegram: {
                bg: "rgba(34,211,238,0.15)",
                text: "#22d3ee",
                label: "Telegram",
              },
              api: { bg: "rgba(251,146,60,0.15)", text: "#fb923c", label: "API" },
            };

            async function loadCommunications() {
              const container = document.getElementById("comm-list-container");
              const channel = document.getElementById("comm-channel-filter").value;
              const url = channel
                ? `/api/gigi/communications?channel=${channel}&limit=50`
                : "/api/gigi/communications?limit=50";
              try {
                const resp = await fetch(url);
                const data = await resp.json();
                if (
                  data.success &&
                  data.communications &&
                  data.communications.length > 0
                ) {
                  document.getElementById("comm-count-label").textContent =
                    `${data.communications.length} interactions`;
                  const html = data.communications
                    .map((item) => {
                      const ch = channelColors[item.type] || {
                        bg: "rgba(148,163,184,0.15)",
                        text: "#94a3b8",
                        label: item.type,
                      };
                      const fbRating = item.feedback ? item.feedback.rating : null;
                      const feedbackIcon =
                        fbRating === "good"
                          ? '<i class="bi bi-check-circle-fill text-success"></i>'
                          : fbRating === "needs_improvement"
                            ? '<i class="bi bi-exclamation-circle-fill" style="color:#f59e0b;"></i>'
                            : '<i class="bi bi-circle text-secondary opacity-50"></i>';
                      const preview =
                        (item.user_message || "").substring(0, 80) +
                        ((item.user_message || "").length > 80 ? "..." : "");
                      const ts = new Date(item.timestamp).toLocaleString([], {
                        month: "short",
                        day: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                      });
                      return `
                              <div class="p-3 border-bottom border-secondary border-opacity-10 d-flex justify-content-between align-items-center"
                                   style="cursor:pointer;" onclick="viewInteraction('${item.id}', '${item.type}')">
                                  <div style="min-width:0; flex:1;">
                                      <div class="d-flex align-items-center gap-2 mb-1">
                                          <span class="badge" style="background:${ch.bg}; color:${ch.text}; font-size:10px;">${ch.label}</span>
                                          <span class="fw-bold small">${item.user_identifier || "Unknown"}</span>
                                          <span class="text-secondary" style="font-size:11px;">${ts}</span>
                                      </div>
                                      <div class="text-secondary small text-truncate">${preview || "<em>No message preview</em>"}</div>
                                  </div>
                                  <div class="ms-3 d-flex align-items-center gap-2">
                                      ${feedbackIcon}
                                      <i class="bi bi-chevron-right text-secondary opacity-50"></i>
                                  </div>
                              </div>`;
                    })
                    .join("");
                  container.innerHTML = html;
                } else {
                  container.innerHTML =
                    '<div class="text-center py-5 text-secondary">No communications found for this filter.</div>';
                  document.getElementById("comm-count-label").textContent =
                    "0 interactions";
                }
              } catch (err) {
                console.error("Failed to load communications:", err);
                container.innerHTML =
                  '<div class="text-center py-5 text-danger small">Failed to load communications.</div>';
              }
            }

            async function loadCommStats() {
              try {
                const resp = await fetch("/api/gigi/communications/stats");
                const data = await resp.json();
                if (data.success) {
                  const s = data.stats;
                  document.getElementById("comm-stats-reviewed").textContent =
                    `${s.reviewed || 0} reviewed`;
                  document.getElementById("comm-stats-good").textContent =
                    `${s.good || 0} good`;
                  document.getElementById("comm-stats-improve").textContent =
                    `${s.needs_improvement || 0} needs work`;
                }
              } catch (err) {
                console.error("Failed to load comm stats:", err);
              }
            }

            async function viewInteraction(id, channel) {
              currentInteractionId = id;
              currentInteractionType = channel;
              if (!detailModal)
                detailModal = new bootstrap.Modal(
                  document.getElementById("interactionDetailModal"),
                );

              // Reset state
              document.getElementById("feedback-buttons").style.display = "flex";
              document.getElementById("improvement-input").style.display = "none";
              document.getElementById("feedback-result").style.display = "none";
              document.getElementById("detail-audio-player").style.display = "none";
              document.getElementById("detail-messages").innerHTML =
                '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

              const ch = channelColors[channel] || {
                bg: "rgba(148,163,184,0.15)",
                text: "#94a3b8",
                label: channel,
              };
              document.getElementById("detail-channel-badge").style.background =
                ch.bg;
              document.getElementById("detail-channel-badge").style.color = ch.text;
              document.getElementById("detail-channel-badge").textContent = ch.label;

              detailModal.show();

              try {
                const resp = await fetch(
                  `/api/gigi/communications/${id}?type=${channel}`,
                );
                const data = await resp.json();
                if (data.success) {
                  let messages = [];

                  if (data.type === "voice" && data.detail) {
                    // Voice call from Retell
                    document.getElementById("detail-user-id").textContent =
                      data.detail.from_number || "Voice Call";
                    if (data.detail.recording_url) {
                      document.getElementById("detail-audio-player").style.display =
                        "block";
                      document.getElementById("detail-audio-el").src =
                        data.detail.recording_url;
                    }
                    const transcript =
                      data.detail.transcript_object || data.detail.transcript || [];
                    if (Array.isArray(transcript)) {
                      messages = transcript.map((t) => ({
                        role: t.role === "agent" ? "assistant" : t.role,
                        content: t.content || "",
                        timestamp: null,
                      }));
                    }
                  } else {
                    // Conversation store (SMS, DM, etc.)
                    document.getElementById("detail-user-id").textContent =
                      data.user_id || "Unknown User";
                    messages = data.messages || [];
                  }

                  // Extract first user msg and first gigi response for feedback context
                  currentUserMessage =
                    (messages.find((m) => m.role === "user") || {}).content || "";
                  currentGigiResponse =
                    (
                      messages.find(
                        (m) => m.role === "assistant" || m.role === "gigi",
                      ) || {}
                    ).content || "";
                  currentUserIdentifier =
                    document.getElementById("detail-user-id").textContent;

                  // Render messages
                  if (messages.length > 0) {
                    const msgsHtml = messages
                      .map((m) => {
                        const isGigi = m.role === "assistant" || m.role === "gigi";
                        return `<div class="mb-2 ${isGigi ? "ps-3" : ""}" style="border-left: ${isGigi ? "2px solid var(--accent-primary)" : "none"};">
                                      <div style="font-size:11px; color: var(--text-secondary);">${isGigi ? "Gigi" : "User"} &middot; ${m.timestamp ? new Date(m.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) : ""}</div>
                                      <div style="color: var(--text-primary);">${m.content}</div>
                                  </div>`;
                      })
                      .join("");
                    document.getElementById("detail-messages").innerHTML = msgsHtml;
                  } else {
                    document.getElementById("detail-messages").innerHTML =
                      '<div class="text-secondary text-center py-3">No message details available.</div>';
                  }

                  // Show existing feedback if already reviewed
                  if (data.feedback) {
                    document.getElementById("feedback-buttons").style.display =
                      "none";
                    const fbHtml =
                      data.feedback.rating === "good"
                        ? '<span class="text-success"><i class="bi bi-check-circle-fill"></i> Rated: Good Response</span>'
                        : `<span style="color:#f59e0b;"><i class="bi bi-exclamation-circle-fill"></i> Rated: Needs Improvement</span><br><small class="text-secondary">${data.feedback.improvement_notes || ""}</small>`;
                    document.getElementById("feedback-result").innerHTML = fbHtml;
                    document.getElementById("feedback-result").style.display =
                      "block";
                  }
                }
              } catch (err) {
                console.error("Failed to load interaction detail:", err);
                document.getElementById("detail-messages").innerHTML =
                  '<div class="text-danger text-center">Failed to load details.</div>';
              }
            }

            function showImprovementInput() {
              document.getElementById("improvement-input").style.display = "block";
              document.getElementById("improvement-notes").focus();
            }

            async function submitFeedback(rating) {
              if (!currentInteractionId) return;
              const notes =
                rating === "needs_improvement"
                  ? document.getElementById("improvement-notes").value.trim()
                  : "";
              if (rating === "needs_improvement" && !notes) {
                document
                  .getElementById("improvement-notes")
                  .classList.add("border-warning");
                document.getElementById("improvement-notes").placeholder =
                  "Please describe how Gigi should improve...";
                return;
              }

              const btn = event.target.closest("button");
              btn.disabled = true;
              btn.innerHTML =
                '<span class="spinner-border spinner-border-sm"></span>';

              try {
                const resp = await fetch(
                  `/api/gigi/communications/${currentInteractionId}/feedback`,
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      rating: rating,
                      improvement_notes: notes,
                      interaction_type: currentInteractionType,
                      user_message: currentUserMessage,
                      gigi_response: currentGigiResponse,
                      user_identifier: currentUserIdentifier,
                      reviewed_by:
                        '{{ current_user.email if current_user else "admin" }}',
                    }),
                  },
                );
                const data = await resp.json();
                if (data.success) {
                  document.getElementById("feedback-buttons").style.display = "none";
                  document.getElementById("improvement-input").style.display = "none";
                  const resultEl = document.getElementById("feedback-result");
                  resultEl.style.display = "block";
                  resultEl.innerHTML =
                    rating === "good"
                      ? '<span class="text-success"><i class="bi bi-check-circle-fill"></i> Feedback saved â€” Gigi will remember this as a good pattern!</span>'
                      : '<span style="color:#f59e0b;"><i class="bi bi-exclamation-circle-fill"></i> Correction saved â€” Gigi will learn from this feedback!</span>';
                  // Refresh stats and list
                  loadCommStats();
                  loadCommunications();
                } else {
                  btn.disabled = false;
                  btn.innerHTML =
                    rating === "good"
                      ? '<i class="bi bi-hand-thumbs-up-fill"></i> Good Response'
                      : "Submit Correction";
                  alert(
                    "Failed to save feedback: " + (data.error || "Unknown error"),
                  );
                }
              } catch (err) {
                console.error("Feedback submission failed:", err);
                btn.disabled = false;
                btn.innerHTML =
                  rating === "good"
                    ? '<i class="bi bi-hand-thumbs-up-fill"></i> Good Response'
                    : "Submit Correction";
              }
            }

            // Escalations Tab
            async function loadEscalations() {
              try {
                const resp = await fetch("/api/gigi/escalations");
                const data = await resp.json();

                if (data.success) {
                  renderEscalations(data.issues);
                  renderVoiceLog(data.voice_activity);
                }

                // Load bot conversations too
                loadBotActivity();
              } catch (err) {
                console.error("Failed to load escalations", err);
              }
            }

            async function loadBotActivity() {
              const container = document.getElementById("bot-activity-list");
              try {
                const resp = await fetch("/api/gigi/activity?limit=20");
                const data = await resp.json();

                if (data.activities && data.activities.length > 0) {
                  container.innerHTML = data.activities
                    .map(
                      (a) => `
                              <div class="p-3 border-bottom border-secondary border-opacity-10 d-flex justify-content-between align-items-center">
                                  <div>
                                      <div class="fw-bold small mb-1">${a.type.replace("_", " ").toUpperCase()}</div>
                                      <div class="text-secondary small">${a.description}</div>
                                  </div>
                                  <div class="text-end">
                                      <span class="badge ${a.status === "success" ? "bg-success" : "bg-warning"} bg-opacity-10 text-opacity-75 small mb-1">${a.status}</span>
                                      <div class="text-secondary small" style="font-size: 10px;">${new Date(a.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>
                                  </div>
                              </div>
                          `,
                    )
                    .join("");
                } else {
                  container.innerHTML =
                    '<div class="p-4 text-center text-secondary small">No recent bot activity recorded.</div>';
                }
              } catch (err) {
                container.innerHTML =
                  '<div class="p-4 text-center text-danger small">Failed to load activity log.</div>';
              }
            }

            function renderEscalations(issues) {
              const body = document.getElementById("escalations-table-body");
              if (!issues || issues.length === 0) {
                body.innerHTML =
                  '<tr><td colspan="5" class="text-center py-5 text-secondary">No urgent escalations found.</td></tr>';
                return;
              }

              body.innerHTML = issues
                .map(
                  (i) => `
                      <tr>
                          <td>
                              <div class="fw-bold">${i.category.replace("_", " ").toUpperCase()}</div>
                              <div class="text-secondary small text-truncate" style="max-width: 250px;">${i.description}</div>
                          </td>
                          <td class="fw-bold">${i.client_name}</td>
                          <td>${new Date(i.created_at).toLocaleString([], { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" })}</td>
                          <td><span class="status-badge bg-danger bg-opacity-10 text-danger">${i.severity}</span></td>
                          <td class="text-end">
                              <button class="btn btn-link text-secondary p-0" onclick="viewIssue(${i.id})">
                                  <i class="bi bi-chevron-right"></i>
                              </button>
                          </td>
                      </tr>
                  `,
                )
                .join("");
            }

            function renderVoiceLog(activity) {
              const container = document.getElementById("voice-log-list");
              if (!activity || activity.length === 0) {
                container.innerHTML =
                  '<div class="text-center py-4 text-secondary small">No recent voice calls recorded.</div>';
                return;
              }

              container.innerHTML = activity
                .map((v) => {
                  const isTransfer = v.event_type === "call_transfer";
                  const badgeClass = isTransfer ? "bg-primary" : "bg-success";
                  const icon = isTransfer ? "ðŸ“²" : "ðŸ“ž";

                  return `
                          <div class="stat-card">
                              <div class="d-flex justify-content-between align-items-start mb-2">
                                  <span class="badge ${badgeClass} bg-opacity-10 text-opacity-100 small" style="font-size: 9px;">${v.event_type.replace("_", " ").toUpperCase()}</span>
                                  <span class="text-secondary small" style="font-size: 10px;">${v.time_ago}</span>
                              </div>
                              <div class="fw-bold mb-1">${icon} ${v.description}</div>
                              <div class="text-secondary small mb-2">${v.details || ""}</div>
                              ${
                                v.metadata && v.metadata.recording_url
                                  ? `
                                  <a href="${v.metadata.recording_url}" target="_blank" class="btn btn-link btn-sm p-0 text-info text-decoration-none" style="font-size: 11px;">
                                      <i class="bi bi-play-circle"></i> Listen to Recording
                                  </a>
                              `
                                  : ""
                              }
                          </div>
                      `;
                })
                .join("");
            }

            // Schedule Tab
            async function loadSchedule() {
              const body = document.getElementById("schedule-table-body");
              try {
                const resp = await fetch("/api/gigi/schedule");
                const data = await resp.json();

                if (data.success) {
                  renderSchedule(data.shifts);
                  updateScheduleStats(data.shifts);
                }
              } catch (err) {
                console.error("Failed to load schedule", err);
                body.innerHTML =
                  '<tr><td colspan="7" class="text-center py-5 text-danger">Failed to load schedule.</td></tr>';
              }
            }

            function renderSchedule(shifts) {
              const body = document.getElementById("schedule-table-body");
              if (!shifts || shifts.length === 0) {
                body.innerHTML =
                  '<tr><td colspan="7" class="text-center py-5 text-secondary">No shifts scheduled for today.</td></tr>';
                return;
              }

              body.innerHTML = shifts
                .map((s) => {
                  const status = s.status.toLowerCase();
                  let badgeClass = "bg-secondary";
                  if (status === "open" || !s.caregiver_id) badgeClass = "bg-danger";
                  else if (status === "in_progress") badgeClass = "bg-info";
                  else if (status === "completed") badgeClass = "bg-success";
                  else if (status === "scheduled") badgeClass = "bg-primary";

                  return `
                          <tr>
                              <td><span class="status-badge ${badgeClass} bg-opacity-10">${status}</span></td>
                              <td class="fw-bold">${s.client_first_name} ${s.client_last_name}</td>
                              <td>${s.caregiver_name || '<span class="text-danger fw-bold">UNASSIGNED</span>'}</td>
                              <td>${s.start_time} - ${s.end_time}</td>
                              <td>${s.duration_hours.toFixed(1)} hrs</td>
                              <td class="small text-secondary">${s.city || "CO"}</td>
                              <td class="text-end">
                                  <button class="btn btn-link text-secondary p-0" onclick="viewShift('${s.id}')">
                                      <i class="bi bi-eye"></i>
                                  </button>
                              </td>
                          </tr>
                      `;
                })
                .join("");
            }

            function updateScheduleStats(shifts) {
              document.getElementById("stat-sched-total").textContent = shifts.length;
              document.getElementById("stat-sched-open").textContent = shifts.filter(
                (s) => s.status.toLowerCase() === "open" || !s.caregiver_id,
              ).length;
              document.getElementById("stat-sched-progress").textContent =
                shifts.filter((s) => s.status.toLowerCase() === "in_progress").length;
              document.getElementById("stat-sched-done").textContent = shifts.filter(
                (s) => s.status.toLowerCase() === "completed",
              ).length;
            }

            let rawSOPContent = "";

            // Knowledge Tab Switcher
            function switchKnowledge(type) {
              document
                .getElementById("subnav-sop")
                .classList.toggle("active", type === "sop");
              document
                .getElementById("subnav-clients")
                .classList.toggle("active", type === "clients");
              document
                .getElementById("subnav-memories")
                .classList.toggle("active", type === "memories");

              document
                .getElementById("view-sop")
                .classList.toggle("d-none", type !== "sop");
              document
                .getElementById("view-clients")
                .classList.toggle("d-none", type !== "clients");
              document
                .getElementById("view-memories")
                .classList.toggle("d-none", type !== "memories");

              // Hide edit actions if not on SOP tab or if switching
              document
                .getElementById("sop-actions")
                .classList.toggle("d-none", type !== "sop");
              cancelSOPEdit(); // Reset edit state when switching

              if (type === "memories") loadMemories();
              if (type === "sop") loadSOP();
              if (type === "clients") loadClients();
            }

            async function loadSOP() {
              const container = document.getElementById("view-sop");
              try {
                const resp = await fetch("/api/gigi/knowledge/sop");
                const data = await resp.json();
                if (data.success) {
                  rawSOPContent = data.content;
                  container.innerHTML = marked.parse(data.content);
                } else {
                  container.innerHTML = `<div class="text-danger">Error: ${data.error}</div>`;
                }
              } catch (err) {
                container.innerHTML =
                  '<div class="text-danger">Failed to load Knowledge Base.</div>';
              }
            }

            function enableSOPEdit() {
              document.getElementById("view-sop").classList.add("d-none");
              document.getElementById("edit-sop").classList.remove("d-none");
              document.getElementById("btn-edit-sop").classList.add("d-none");
              document.getElementById("sop-edit-buttons").classList.remove("d-none");
              document.getElementById("sop-textarea").value = rawSOPContent;
            }

            function cancelSOPEdit() {
              document.getElementById("view-sop").classList.remove("d-none");
              document.getElementById("edit-sop").classList.add("d-none");
              document.getElementById("btn-edit-sop").classList.remove("d-none");
              document.getElementById("sop-edit-buttons").classList.add("d-none");
            }

            async function saveSOP() {
              const newContent = document.getElementById("sop-textarea").value;
              const btn = document.querySelector("#sop-edit-buttons .btn-primary");
              const originalText = btn.innerHTML;

              btn.disabled = true;
              btn.innerHTML =
                '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

              try {
                const resp = await fetch("/api/gigi/knowledge/sop", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ content: newContent }),
                });

                const data = await resp.json();
                if (data.success) {
                  rawSOPContent = newContent;
                  document.getElementById("view-sop").innerHTML =
                    marked.parse(newContent);
                  cancelSOPEdit();
                } else {
                  alert("Error saving SOP: " + data.error);
                }
              } catch (err) {
                console.error("Save error", err);
                alert("Failed to save SOP. Check connection.");
              } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
              }
            }

            async function loadMemories() {
              const grid = document.getElementById("memory-grid");
              grid.innerHTML =
                '<div class="text-center py-5 w-100 text-secondary">Loading Gigi\'s memories...</div>';

              try {
                const resp = await fetch("/api/gigi/knowledge/memories");
                const data = await resp.json();

                if (data.success) {
                  if (!data.memories || data.memories.length === 0) {
                    grid.innerHTML =
                      '<div class="text-center py-5 w-100 text-secondary">No active memories yet.</div>';
                    return;
                  }

                  grid.innerHTML = data.memories
                    .map(
                      (m) => `
                              <div class="memory-card">
                                  <div class="memory-header">
                                      <span class="memory-type text-info">${m.type.replace("_", " ")}</span>
                                      <span class="badge bg-primary bg-opacity-10 text-primary small">${m.category}</span>
                                  </div>
                                  <div class="memory-content">${m.content}</div>
                                  <div class="memory-footer">
                                      <div class="d-flex align-items-center gap-2">
                                          <div class="confidence-bar">
                                              <div class="confidence-fill" style="width: ${m.confidence * 100}%"></div>
                                          </div>
                                          <span class="small">${Math.round(m.confidence * 100)}% Match</span>
                                      </div>
                                      <span>${new Date(m.created_at).toLocaleDateString()}</span>
                                  </div>
                              </div>
                          `,
                    )
                    .join("");
                }
              } catch (err) {
                grid.innerHTML =
                  '<div class="text-center py-5 w-100 text-danger">Failed to load memories.</div>';
              }
            }

            // Client Tiles
            let allClientTiles = [];

            async function loadClients() {
              const grid = document.getElementById("client-grid");
              grid.innerHTML =
                '<div class="text-center py-5 w-100 text-secondary">Loading clients from WellSky...</div>';

              try {
                const resp = await fetch("/api/gigi/knowledge/clients");
                const data = await resp.json();

                if (data.success && data.clients.length > 0) {
                  allClientTiles = data.clients;
                  renderClientTiles(allClientTiles);
                } else {
                  grid.innerHTML =
                    '<div class="text-center py-5 w-100 text-secondary">No active clients found.</div>';
                }
              } catch (err) {
                grid.innerHTML =
                  '<div class="text-center py-5 w-100 text-danger">Failed to load clients.</div>';
              }
            }

            function renderClientTiles(clients) {
              const grid = document.getElementById("client-grid");
              grid.innerHTML = clients
                .map(
                  (c) => `
                      <div class="client-tile" data-name="${(c.full_name || "").toLowerCase()}" id="client-tile-${c.id}">
                          <div class="client-tile-header">
                              <div class="client-tile-name">${c.full_name || "Unknown"}</div>
                              <span class="client-tile-status ${c.is_active ? "active" : "inactive"}">${c.is_active ? "Active" : "Inactive"}</span>
                          </div>
                          <div class="client-tile-info">
                              ${c.phone ? '<i class="bi bi-telephone"></i> ' + c.phone + "<br>" : ""}
                              ${c.city ? '<i class="bi bi-geo-alt"></i> ' + c.city + (c.state ? ", " + c.state : "") + "<br>" : ""}
                              ${c.emergency_contact_name ? '<i class="bi bi-person-badge"></i> Emergency: ' + c.emergency_contact_name + (c.emergency_contact_phone ? " (" + c.emergency_contact_phone + ")" : "") + "<br>" : ""}
                              ${c.authorized_hours_weekly ? '<i class="bi bi-clock"></i> ' + c.authorized_hours_weekly + " hrs/week authorized" : ""}
                          </div>
                          <div class="client-tile-prompt">
                              <label>Gigi Prompt for This Client</label>
                              <textarea
                                  id="prompt-${c.id}"
                                  placeholder="e.g., Client prefers morning calls. Daughter Janet is primary contact. Has a cat named Whiskers..."
                                  oninput="showSaveBtn('${c.id}')"
                              >${c.prompt || ""}</textarea>
                              <div class="client-tile-save" id="save-btn-${c.id}">
                                  <button class="btn btn-primary btn-sm" onclick="saveClientPrompt('${c.id}', '${(c.full_name || "").replace(/'/g, "\\'")}')">
                                      <i class="bi bi-check-lg"></i> Save
                                  </button>
                              </div>
                          </div>
                      </div>
                  `,
                )
                .join("");
            }

            function showSaveBtn(clientId) {
              document
                .getElementById("save-btn-" + clientId)
                .classList.add("visible");
            }

            async function saveClientPrompt(clientId, clientName) {
              const textarea = document.getElementById("prompt-" + clientId);
              const saveDiv = document.getElementById("save-btn-" + clientId);
              const btn = saveDiv.querySelector("button");
              const origText = btn.innerHTML;

              btn.disabled = true;
              btn.innerHTML =
                '<span class="spinner-border spinner-border-sm"></span> Saving...';

              try {
                const resp = await fetch(
                  "/api/gigi/knowledge/clients/" + clientId + "/prompt",
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      prompt: textarea.value,
                      client_name: clientName,
                    }),
                  },
                );
                const data = await resp.json();
                if (data.success) {
                  saveDiv.classList.remove("visible");
                  btn.innerHTML = '<i class="bi bi-check-lg"></i> Saved!';
                  setTimeout(() => {
                    btn.innerHTML = origText;
                  }, 1500);
                } else {
                  alert("Error saving prompt: " + data.error);
                  btn.innerHTML = origText;
                }
              } catch (err) {
                alert("Failed to save prompt.");
                btn.innerHTML = origText;
              } finally {
                btn.disabled = false;
              }
            }

            function filterClients(query) {
              const q = query.toLowerCase().trim();
              document.querySelectorAll(".client-tile").forEach((tile) => {
                const name = tile.getAttribute("data-name") || "";
                tile.classList.toggle("d-none-filter", q && !name.includes(q));
              });
            }

            async function loadIssues() {
              try {
                const resp = await fetch("/api/gigi/issues");
                const data = await resp.json();

                if (data.success) {
                  renderIssues(data.issues);
                  updateStats(data.issues);
                }
              } catch (err) {
                console.error("Failed to load issues", err);
              }
            }

            function renderIssues(issues) {
              const body = document.getElementById("issues-table-body");
              if (!issues || issues.length === 0) {
                body.innerHTML =
                  '<tr><td colspan="8" class="text-center py-5 text-secondary"><i class="bi bi-check-circle me-2"></i>No issues found. Issues are auto-detected from client complaints or can be reported manually.</td></tr>';
                return;
              }

              body.innerHTML = issues
                .map((issue) => {
                  const date = new Date(issue.created_at).toLocaleDateString();
                  const time = new Date(issue.created_at).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  });
                  const claimedBadge = issue.claimed_by
                    ? `<span class="badge bg-info bg-opacity-25 text-info ms-1" title="Claimed at ${issue.claimed_at || ""}">${issue.claimed_by.split("@")[0]}</span>`
                    : "";

                  const claimBtn =
                    issue.status === "resolved"
                      ? ""
                      : issue.claimed_by
                        ? `<button class="btn btn-sm btn-outline-secondary" onclick="releaseIssue(${issue.id})" title="Release"><i class="bi bi-arrow-counterclockwise"></i></button>`
                        : `<button class="btn btn-sm btn-outline-primary" onclick="claimIssue(${issue.id})" title="I'm handling this"><i class="bi bi-hand-index"></i> Claim</button>`;

                  const resolveBtn =
                    issue.status === "resolved"
                      ? '<span class="badge bg-success bg-opacity-25 text-success">Resolved</span>'
                      : `<button class="btn btn-sm btn-outline-success ms-1" onclick="resolveIssue(${issue.id})" title="Mark resolved"><i class="bi bi-check-circle"></i></button>`;

                  return `
                          <tr>
                              <td class="text-secondary small">#${issue.id}</td>
                              <td class="fw-bold">${issue.client_name}</td>
                              <td>${issue.caregiver_involved || '<span class="text-muted">â€”</span>'}</td>
                              <td><span class="text-capitalize">${issue.category.replace("_", " ")}</span></td>
                              <td><span class="priority-${issue.severity} fw-bold">${issue.severity.toUpperCase()}</span></td>
                              <td><span class="status-badge bg-secondary bg-opacity-10">${issue.status}</span>${claimedBadge}</td>
                              <td>
                                  <div>${date}</div>
                                  <div class="text-secondary small">${time}</div>
                              </td>
                              <td class="text-end text-nowrap">
                                  ${claimBtn} ${resolveBtn}
                              </td>
                          </tr>
                      `;
                })
                .join("");
            }

            function updateStats(issues) {
              document.getElementById("stat-total").textContent = issues.length;
              document.getElementById("stat-urgent").textContent = issues.filter(
                (i) => i.severity === "high" || i.severity === "critical",
              ).length;
              document.getElementById("stat-progress").textContent = issues.filter(
                (i) => i.status === "in_progress",
              ).length;
              document.getElementById("stat-resolved").textContent = issues.filter(
                (i) => i.status === "resolved",
              ).length;
            }

            async function claimIssue(id) {
              try {
                const resp = await fetch(`/api/gigi/issues/${id}/claim`, {
                  method: "POST",
                });
                if (resp.ok) {
                  loadIssues();
                } else {
                  const err = await resp.json();
                  alert(err.error || "Could not claim issue");
                }
              } catch (e) {
                alert("Error claiming issue");
              }
            }

            async function releaseIssue(id) {
              try {
                const resp = await fetch(`/api/gigi/issues/${id}/release`, {
                  method: "POST",
                });
                if (resp.ok) {
                  loadIssues();
                }
              } catch (e) {
                alert("Error releasing issue");
              }
            }

            async function resolveIssue(id) {
              const notes = prompt("Resolution notes (what was done):");
              if (notes === null) return;
              try {
                const resp = await fetch(`/api/gigi/issues/${id}/resolve`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ resolution_notes: notes }),
                });
                if (resp.ok) {
                  loadIssues();
                } else {
                  alert("Could not resolve issue");
                }
              } catch (e) {
                alert("Error resolving issue");
              }
            }

            function showCreateIssueModal() {
              document.getElementById("createIssueForm").reset();
              document.getElementById("selectedClientId").value = "";
              document.getElementById("selectedCaregiverId").value = "";
              createModal.show();
            }

            function setupAutocompletes() {
              setupSearch(
                "clientSearch",
                "clientSuggestions",
                "/api/wellsky/clients",
                "selectedClientId",
              );
              setupSearch(
                "caregiverSearch",
                "caregiverSuggestions",
                "/api/wellsky/caregivers",
                "selectedCaregiverId",
              );
              setupSearch(
                "shiftSearch",
                "shiftSuggestions",
                "/api/wellsky/shifts",
                "selectedShiftId",
                "selectedClientId",
              );
            }

            function setupSearch(
              inputId,
              suggestionsId,
              apiPath,
              hiddenId,
              dependentId = null,
            ) {
              const input = document.getElementById(inputId);
              const suggestions = document.getElementById(suggestionsId);
              let timeout;

              input.addEventListener("input", () => {
                clearTimeout(timeout);
                const query = input.value.trim();

                // For shifts, we might want to show all for client even if query is empty
                if (query.length < 2 && inputId !== "shiftSearch") {
                  suggestions.classList.add("d-none");
                  return;
                }

                timeout = setTimeout(async () => {
                  try {
                    let url = `${apiPath}?limit=10&q=${encodeURIComponent(query)}`;
                    if (dependentId) {
                      const depVal = document.getElementById(dependentId).value;
                      if (depVal) url += `&clientId=${depVal}`;
                    }

                    const resp = await fetch(url);
                    const data = await resp.json();
                    const items =
                      data.clients || data.caregivers || data.shifts || [];

                    if (items.length > 0) {
                      suggestions.innerHTML = items
                        .map((item) => {
                          let displayName = item.full_name || item.name;
                          if (inputId === "shiftSearch") {
                            displayName = `${item.date} | ${item.start_time} - ${item.caregiver_name}`;
                          }
                          return `
                                          <div class="suggestion-item" onclick="selectItem('${inputId}', '${suggestionsId}', '${displayName}', '${item.id}', '${hiddenId}')">
                                              ${displayName}
                                          </div>
                                      `;
                        })
                        .join("");
                      suggestions.classList.remove("d-none");
                    } else {
                      suggestions.classList.add("d-none");
                    }
                  } catch (err) {
                    console.error("Search error", err);
                  }
                }, 300);
              });

              // Close on blur
              document.addEventListener("click", (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                  suggestions.classList.add("d-none");
                }
              });
            }

            window.selectItem = (inputId, suggestionsId, name, id, hiddenId) => {
              document.getElementById(inputId).value = name;
              document.getElementById(hiddenId).value = id;
              document.getElementById(suggestionsId).classList.add("d-none");
            };

            async function saveIssue() {
              const clientName = document.getElementById("clientSearch").value;
              const clientId = document.getElementById("selectedClientId").value;
              const caregiver = document.getElementById("caregiverSearch").value;
              const category = document.getElementById("issueType").value;
              const severity = document.getElementById("issuePriority").value;
              const status = document.getElementById("issueStatus").value;
              const description = document.getElementById("issueDescription").value;

              if (!clientName || !description) {
                alert("Please fill in all required fields.");
                return;
              }

              try {
                const resp = await fetch("/api/client-satisfaction/complaints", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    client_name: clientName,
                    client_id: clientId,
                    caregiver_involved: caregiver,
                    category: category,
                    severity: severity,
                    status: status,
                    description: description,
                    complaint_date: new Date().toISOString().split("T")[0],
                    source: "manual",
                  }),
                });

                if (resp.ok) {
                  createModal.hide();
                  loadIssues();
                } else {
                  const err = await resp.json();
                  alert("Error: " + (err.detail || "Failed to save issue"));
                }
              } catch (err) {
                console.error("Save error", err);
                alert("Connection error. Please try again.");
              }
            }

            // =============================================================================
            // SIMULATIONS TAB
            // =============================================================================
            let callDetailModal;
            let scenariosData = [];

            function runNewSimulation() {
              switchSimulations("scenarios");
              document
                .getElementById("view-scenarios")
                .scrollIntoView({ behavior: "smooth" });
            }

            async function loadCurrentVoiceModel() {
              const select = document.getElementById("voice-model-select");
              const status = document.getElementById("voice-model-status");
              try {
                const resp = await fetch("/api/gigi/voice-model");
                const data = await resp.json();
                if (data.success) {
                  const cur = data.current;
                  if (cur.provider && cur.model) {
                    select.value = cur.provider + "|" + cur.model;
                    status.textContent = "Override active";
                    status.className = "badge bg-warning bg-opacity-25 text-warning small";
                  } else {
                    select.value = "default";
                    status.textContent = data.default_provider + "/" + data.default_model;
                    status.className = "badge bg-secondary bg-opacity-25 text-secondary small";
                  }
                }
              } catch (err) {
                console.error("Failed to load voice model:", err);
              }
            }

            async function setVoiceModel() {
              const select = document.getElementById("voice-model-select");
              const status = document.getElementById("voice-model-status");
              const val = select.value;

              let provider, model;
              if (val === "default") {
                provider = "default";
                model = "";
              } else {
                const parts = val.split("|");
                provider = parts[0];
                model = parts[1];
              }

              status.textContent = "Saving...";
              status.className = "badge bg-info bg-opacity-25 text-info small";

              try {
                const resp = await fetch("/api/gigi/voice-model", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ provider: provider, model: model }),
                });
                const data = await resp.json();
                if (data.success) {
                  if (provider === "default") {
                    status.textContent = data.provider + "/" + data.model;
                    status.className = "badge bg-secondary bg-opacity-25 text-secondary small";
                  } else {
                    status.textContent = "Active: " + data.provider + "/" + data.model;
                    status.className = "badge bg-warning bg-opacity-25 text-warning small";
                  }
                  showToast("Voice model updated: " + (data.message || ""), "success");
                } else {
                  showToast("Error: " + (data.error || "Unknown error"), "danger");
                  loadCurrentVoiceModel();
                }
              } catch (err) {
                showToast("Failed to update model", "danger");
                console.error(err);
                loadCurrentVoiceModel();
              }
            }

            function switchSimulations(view) {
              document
                .getElementById("subnav-scenarios")
                .classList.toggle("active", view === "scenarios");
              document
                .getElementById("subnav-history")
                .classList.toggle("active", view === "history");
              document
                .getElementById("subnav-calls")
                .classList.toggle("active", view === "calls");
              document
                .getElementById("view-scenarios")
                .classList.toggle("d-none", view !== "scenarios");
              document
                .getElementById("view-history")
                .classList.toggle("d-none", view !== "history");
              document
                .getElementById("view-calls")
                .classList.toggle("d-none", view !== "calls");

              if (view === "history") loadSimulationHistory();
              if (view === "calls") loadCallHistory();
            }

            async function loadScenarios() {
              const grid = document.getElementById("scenarios-grid");
              try {
                const resp = await fetch("/api/gigi/simulations/scenarios");
                const data = await resp.json();

                if (data.success) {
                  scenariosData = data.scenarios;
                  grid.innerHTML = data.scenarios
                    .map(
                      (s) => `
                              <div class="col-md-6 col-lg-4">
                                  <div class="stat-card h-100" data-scenario="${s.id}">
                                      <div class="d-flex justify-content-between align-items-start mb-2">
                                          <span class="fw-bold">${s.name}</span>
                                          ${["rambling_family_loop", "dementia_repeat_loop", "angry_neglect_accusation", "medical_advice_boundary"].includes(s.id) ? '<span class="badge bg-danger">Critical</span>' : ""}
                                      </div>
                                      <p class="text-secondary small mb-3">${s.description}</p>

                                      <div class="mb-3">
                                          <div class="text-secondary small mb-1" style="font-size: 10px;">EXPECTED BEHAVIOR:</div>
                                          <ul class="list-unstyled small mb-0">
                                              ${s.expected_behavior
                                                .slice(0, 3)
                                                .map(
                                                  (b) => `
                                                  <li class="text-secondary mb-1"><i class="bi bi-check2-circle text-success me-1"></i>${b}</li>
                                              `,
                                                )
                                                .join("")}
                                              ${s.expected_behavior.length > 3 ? `<li class="text-muted small">+${s.expected_behavior.length - 3} more...</li>` : ""}
                                          </ul>
                                      </div>

                                      <div class="mb-3">
                                          <div class="text-secondary small mb-1" style="font-size: 10px;">EXPECTED TOOLS:</div>
                                          <div class="d-flex flex-wrap gap-1">
                                              ${s.expected_tools.map((t) => `<span class="badge bg-info bg-opacity-10 text-info" style="font-size: 10px;">${t}</span>`).join("")}
                                          </div>
                                      </div>

                                      <div class="d-flex gap-2 mt-auto">
                                          <button class="btn btn-primary btn-sm flex-grow-1" onclick="runSimulation('${s.id}')">
                                              <i class="bi bi-play-fill"></i> Run Test
                                          </button>
                                          <button class="btn btn-outline-secondary btn-sm" onclick="showScenarioDetail('${s.id}')" title="View Details">
                                              <i class="bi bi-info-circle"></i>
                                          </button>
                                      </div>
                                  </div>
                              </div>
                          `,
                    )
                    .join("");

                  // Auto-refresh history every 10 seconds
                  setInterval(loadSimulationHistory, 10000);
                }
              } catch (err) {
                grid.innerHTML =
                  '<div class="text-danger">Failed to load scenarios</div>';
                console.error(err);
              }
            }

            function showScenarioDetail(scenarioId) {
              const s = scenariosData.find((x) => x.id === scenarioId);
              if (!s) return;

              const content = `
                      <h5>${s.name}</h5>
                      <p class="text-secondary">${s.description}</p>
                      <hr class="border-secondary">
                      <div class="row">
                          <div class="col-md-6">
                              <h6 class="text-secondary small">SIMULATED CALLER</h6>
                              <p><strong>Identity:</strong> ${s.identity}</p>
                              <p><strong>Goal:</strong> ${s.goal}</p>
                              <p><strong>Personality:</strong> ${s.personality}</p>
                          </div>
                          <div class="col-md-6">
                              <h6 class="text-secondary small">SAMPLE MESSAGES</h6>
                              <ul>
                                  ${s.sample_messages.map((m) => `<li class="small">"${m}"</li>`).join("")}
                              </ul>
                          </div>
                      </div>
                      <hr class="border-secondary">
                      <h6 class="text-secondary small">EXPECTED BEHAVIOR (Checklist)</h6>
                      <ul class="list-unstyled">
                          ${s.expected_behavior.map((b) => `<li class="mb-1"><i class="bi bi-square text-secondary me-2"></i>${b}</li>`).join("")}
                      </ul>
                  `;

              // Use a simple alert for now, could be a modal
              const modal = document.createElement("div");
              modal.className = "modal fade";
              modal.id = "scenarioDetailModal";
              modal.innerHTML = `
                      <div class="modal-dialog modal-dialog-centered modal-lg">
                          <div class="modal-content">
                              <div class="modal-header">
                                  <h5 class="modal-title">Test Scenario Details</h5>
                                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">${content}</div>
                              <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                  <button type="button" class="btn btn-primary" onclick="runSimulation('${s.id}'); bootstrap.Modal.getInstance(document.getElementById('scenarioDetailModal')).hide();">
                                      <i class="bi bi-play-fill"></i> Run This Test
                                  </button>
                              </div>
                          </div>
                      </div>
                  `;
              document.body.appendChild(modal);
              const bsModal = new bootstrap.Modal(modal);
              bsModal.show();
              modal.addEventListener("hidden.bs.modal", () => modal.remove());
            }

            async function runSimulation(scenario) {
              const scenarioName =
                scenariosData.find((s) => s.id === scenario)?.name || scenario;
              if (
                !confirm(
                  `Launch Voice Brain simulation for "${scenarioName}"?\n\nThis will test the smart Gigi AI agent automatically.`,
                )
              )
                return;

              const card = document.querySelector(`[data-scenario="${scenario}"]`);
              const btn = card ? card.querySelector(".btn-primary") : null;
              const originalText = btn ? btn.innerHTML : "";

              try {
                if (btn) {
                  btn.innerHTML =
                    '<i class="bi bi-hourglass-split"></i> Launching...';
                  btn.disabled = true;
                }

                const resp = await fetch("/api/gigi/simulations/run", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ scenario: scenario }),
                });
                const data = await resp.json();

                if (data.success) {
                  if (btn) {
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Running...';
                  }

                  // Show toast and auto-switch to history view
                  showToast(
                    "Simulation launched! Switching to history...",
                    "success",
                  );
                  setTimeout(() => switchSimulations("history"), 1000);

                  // Start polling for completion
                  if (data.simulation_id && card) {
                    pollSimulationStatus(data.simulation_id, card, btn, originalText);
                  }

                  // Refresh history after delay
                  setTimeout(loadSimulationHistory, 2000);
                } else {
                  throw new Error(data.error || "Failed to launch simulation");
                }
              } catch (err) {
                console.error("Simulation error:", err);
                if (btn) {
                  btn.innerHTML = originalText;
                  btn.disabled = false;
                }
                showToast(`Error: ${err.message}`, "danger");
              }
            }

            async function pollSimulationStatus(
              simulationId,
              card,
              btn,
              originalText,
            ) {
              const maxPolls = 60; // 2 minutes
              let polls = 0;

              const interval = setInterval(async () => {
                polls++;

                try {
                  const resp = await fetch(
                    `/api/gigi/simulations/${simulationId}/details`,
                  );
                  const data = await resp.json();

                  if (data.success && data.simulation.status === "completed") {
                    clearInterval(interval);

                    const score = data.simulation.overall_score;
                    const status = score >= 70 ? "PASS" : "FAIL";
                    const emoji = score >= 70 ? "âœ…" : "âŒ";

                    if (btn) {
                      btn.innerHTML = `${emoji} ${status} (${score})`;
                      btn.disabled = false;
                    }

                    loadSimulationHistory();
                    showToast(
                      `Simulation completed: ${status} ${score}/100`,
                      score >= 70 ? "success" : "warning",
                    );
                  } else if (data.success && data.simulation.status === "failed") {
                    clearInterval(interval);
                    if (btn) {
                      btn.innerHTML = '<i class="bi bi-x-circle"></i> Failed';
                      btn.disabled = false;
                    }
                    showToast("Simulation failed", "danger");
                  } else if (polls >= maxPolls) {
                    clearInterval(interval);
                    if (btn) {
                      btn.innerHTML = '<i class="bi bi-clock"></i> Timeout';
                      btn.disabled = false;
                    }
                  }
                } catch (err) {
                  console.error("Poll error:", err);
                }
              }, 2000); // Poll every 2 seconds
            }

            function showToast(message, type = "info") {
              const toast = document.createElement("div");
              toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
              toast.style.zIndex = "9999";
              toast.textContent = message;
              document.body.appendChild(toast);

              setTimeout(() => toast.remove(), 5000);
            }

            async function loadSimulationHistory() {
              const tbody = document.getElementById("history-table-body");
              try {
                const resp = await fetch("/api/gigi/simulations/history?limit=50");
                const data = await resp.json();

                if (data.success && data.simulations.length > 0) {
                  tbody.innerHTML = data.simulations
                    .map((sim) => {
                      const statusBadge = getStatusBadge(
                        sim.status,
                        sim.overall_score,
                      );
                      const duration = sim.duration ? `${sim.duration}s` : "-";
                      const time = sim.created_at
                        ? new Date(sim.created_at).toLocaleString()
                        : "N/A";
                      const score =
                        sim.overall_score !== null ? `${sim.overall_score}/100` : "-";

                      return `
                                  <tr>
                                      <td><span class="small text-secondary">#${sim.id}</span></td>
                                      <td><span class="fw-bold small">${sim.scenario_name}</span></td>
                                      <td>${statusBadge}</td>
                                      <td class="text-center">${sim.turns || "-"}</td>
                                      <td class="text-center">${score}</td>
                                      <td class="text-center">${duration}</td>
                                      <td class="small text-secondary">${time}</td>
                                      <td class="text-end">
                                          <button class="btn btn-link btn-sm p-0 text-info" onclick="viewSimulationDetails(${sim.id})">
                                              <i class="bi bi-eye"></i>
                                          </button>
                                      </td>
                                  </tr>
                              `;
                    })
                    .join("");
                } else {
                  tbody.innerHTML =
                    '<tr><td colspan="8" class="text-center py-5 text-secondary">No simulations yet. Run a test to see results here.</td></tr>';
                }
              } catch (err) {
                tbody.innerHTML =
                  '<tr><td colspan="8" class="text-center py-5 text-danger">Failed to load history</td></tr>';
                console.error(err);
              }
            }

            function getStatusBadge(status, score) {
              if (status === "completed") {
                if (score >= 70) {
                  return '<span class="badge bg-success">âœ… PASS</span>';
                } else {
                  return '<span class="badge bg-warning">âš ï¸ FAIL</span>';
                }
              } else if (status === "running") {
                return '<span class="badge bg-info">â–¶ï¸ Running</span>';
              } else if (status === "failed") {
                return '<span class="badge bg-danger">âŒ Error</span>';
              } else {
                return '<span class="badge bg-secondary">â³ Pending</span>';
              }
            }

            async function viewSimulationDetails(simulationId) {
              const modalBody = document.getElementById("simulationDetailBody");
              modalBody.innerHTML =
                '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Loading simulation details...</p></div>';

              if (!callDetailModal) {
                callDetailModal = new bootstrap.Modal(
                  document.getElementById("callDetailModal"),
                );
              }
              callDetailModal.show();

              try {
                const resp = await fetch(
                  `/api/gigi/simulations/${simulationId}/details`,
                );
                const data = await resp.json();

                if (!data.success) {
                  modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                  return;
                }

                const sim = data.simulation;
                const eval = sim.evaluation || {};

                // Build detailed modal content
                modalBody.innerHTML = `
                          <div class="mb-3">
                              <h5>${sim.scenario_name}</h5>
                              <p class="text-muted">${sim.status} â€¢ ${new Date(sim.created_at).toLocaleString()}</p>
                          </div>

                          <div class="row mb-3">
                              <div class="col-4">
                                  <div class="card bg-primary bg-opacity-10">
                                      <div class="card-body text-center">
                                          <h3>${sim.overall_score || "-"}/100</h3>
                                          <small>Overall Score</small>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-4">
                                  <div class="card bg-info bg-opacity-10">
                                      <div class="card-body text-center">
                                          <h3>${sim.tool_score || "-"}/100</h3>
                                          <small>Tool Usage</small>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-4">
                                  <div class="card bg-success bg-opacity-10">
                                      <div class="card-body text-center">
                                          <h3>${sim.behavior_score || "-"}/100</h3>
                                          <small>Behavior</small>
                                      </div>
                                  </div>
                              </div>
                          </div>

                          <h6>Tools Used</h6>
                          <p>${(sim.tools_used || []).join(", ") || "None"}</p>

                          ${
                            eval.tools_missing && eval.tools_missing.length > 0
                              ? `
                              <div class="alert alert-warning">
                                  <strong>Missing Tools:</strong> ${eval.tools_missing.join(", ")}
                              </div>
                          `
                              : ""
                          }

                          <h6>Behavior Analysis</h6>
                          <p>${eval.behavior_analysis || "Not available"}</p>

                          ${
                            eval.strengths && eval.strengths.length > 0
                              ? `
                              <h6>Strengths</h6>
                              <ul>
                                  ${eval.strengths.map((s) => `<li>${s}</li>`).join("")}
                              </ul>
                          `
                              : ""
                          }

                          ${
                            eval.weaknesses && eval.weaknesses.length > 0
                              ? `
                              <h6>Weaknesses</h6>
                              <ul>
                                  ${eval.weaknesses.map((w) => `<li>${w}</li>`).join("")}
                              </ul>
                          `
                              : ""
                          }

                          <h6>Full Transcript</h6>
                          <div class="card bg-dark">
                              <div class="card-body" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                                  ${formatTranscript(sim.transcript_json || [])}
                              </div>
                          </div>

                          <div class="mt-3 text-end">
                              <a href="/api/gigi/simulations/${simulationId}/report" target="_blank" class="btn btn-outline-primary">
                                  <i class="bi bi-file-earmark-text"></i> View Full Report
                              </a>
                          </div>
                      `;

                document.getElementById("callDetailTitle").textContent =
                  `Simulation #${sim.id} - ${sim.scenario_name}`;
              } catch (err) {
                console.error("Failed to load details:", err);
                modalBody.innerHTML =
                  '<div class="alert alert-danger">Error loading simulation details</div>';
              }
            }

            function formatTranscript(transcriptJson) {
              if (!transcriptJson || transcriptJson.length === 0) {
                return '<p class="text-muted">Transcript not available</p>';
              }

              return transcriptJson
                .map((turn) => {
                  const role = turn.role === "assistant" ? "Agent" : "Caller";
                  const className =
                    turn.role === "assistant" ? "text-info" : "text-warning";
                  return `<p><strong class="${className}">${role}:</strong> ${turn.content}</p>`;
                })
                .join("");
            }

            async function loadCallHistory() {
              const tbody = document.getElementById("calls-table-body");
              try {
                const resp = await fetch("/api/gigi/calls/history?limit=50");
                const data = await resp.json();

                if (data.success && data.calls.length > 0) {
                  // Store for detail view
                  window._callHistoryData = data.calls;
                  // Clear existing rows
                  while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

                  data.calls.forEach((call, idx) => {
                    const tr = document.createElement("tr");

                    // Type cell
                    const tdType = document.createElement("td");
                    tdType.className = "small";
                    const typeI = document.createElement("i");
                    if (call.call_type === "web_call") {
                      typeI.className = "bi bi-globe text-info";
                      tdType.appendChild(typeI);
                      tdType.append(" Web");
                    } else if (call.direction === "inbound") {
                      typeI.className = "bi bi-telephone-inbound text-success";
                      tdType.appendChild(typeI);
                      tdType.append(" Inbound");
                    } else {
                      typeI.className = "bi bi-telephone-outbound text-warning";
                      tdType.appendChild(typeI);
                      tdType.append(" Outbound");
                    }
                    tr.appendChild(tdType);

                    // Caller cell
                    const tdCaller = document.createElement("td");
                    tdCaller.className = "small";
                    tdCaller.textContent = call.from_number || "Web Call";
                    tr.appendChild(tdCaller);

                    // Duration cell
                    const tdDur = document.createElement("td");
                    tdDur.className = "text-center small";
                    if (call.duration_seconds) {
                      const m = Math.floor(call.duration_seconds / 60);
                      const s = call.duration_seconds % 60;
                      tdDur.textContent = m + "m " + s + "s";
                    } else {
                      tdDur.textContent = "-";
                    }
                    tr.appendChild(tdDur);

                    // Tools cell
                    const tdTools = document.createElement("td");
                    tdTools.className = "text-center";
                    const toolSpan = document.createElement("span");
                    if (call.tool_count > 0) {
                      toolSpan.className = "badge bg-info bg-opacity-10 text-info";
                    } else {
                      toolSpan.className = "text-secondary";
                    }
                    toolSpan.textContent = String(call.tool_count);
                    tdTools.appendChild(toolSpan);
                    tr.appendChild(tdTools);

                    // Summary cell
                    const tdSum = document.createElement("td");
                    tdSum.className = "small";
                    if (call.summary) {
                      tdSum.textContent = call.summary.length > 80 ? call.summary.slice(0, 80) + "..." : call.summary;
                    } else {
                      tdSum.textContent = "-";
                    }
                    tr.appendChild(tdSum);

                    // Time cell
                    const tdTime = document.createElement("td");
                    tdTime.className = "small text-secondary";
                    tdTime.textContent = call.start_timestamp
                      ? new Date(call.start_timestamp).toLocaleString()
                      : "N/A";
                    tr.appendChild(tdTime);

                    // Actions cell
                    const tdActions = document.createElement("td");
                    tdActions.className = "text-end";
                    const viewBtn = document.createElement("button");
                    viewBtn.className = "btn btn-link btn-sm p-0 text-info";
                    viewBtn.addEventListener("click", () => viewCallDetails(idx));
                    const viewIcon = document.createElement("i");
                    viewIcon.className = "bi bi-eye";
                    viewBtn.appendChild(viewIcon);
                    tdActions.appendChild(viewBtn);

                    if (call.recording_url) {
                      const playLink = document.createElement("a");
                      playLink.href = call.recording_url;
                      playLink.target = "_blank";
                      playLink.className = "btn btn-link btn-sm p-0 text-success ms-2";
                      playLink.title = "Listen";
                      const playIcon = document.createElement("i");
                      playIcon.className = "bi bi-play-circle";
                      playLink.appendChild(playIcon);
                      tdActions.appendChild(playLink);
                    }
                    tr.appendChild(tdActions);

                    tbody.appendChild(tr);
                  });
                } else {
                  while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
                  const tr = document.createElement("tr");
                  const td = document.createElement("td");
                  td.colSpan = 7;
                  td.className = "text-center py-5 text-secondary";
                  td.textContent = "No calls found.";
                  tr.appendChild(td);
                  tbody.appendChild(tr);
                }
              } catch (err) {
                while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
                const tr = document.createElement("tr");
                const td = document.createElement("td");
                td.colSpan = 7;
                td.className = "text-center py-5 text-danger";
                td.textContent = "Failed to load call history";
                tr.appendChild(td);
                tbody.appendChild(tr);
                console.error(err);
              }
            }

            function viewCallDetails(idx) {
              const call = (window._callHistoryData || [])[idx];
              if (!call) return;

              const modalBody = document.getElementById("simulationDetailBody");
              // Clear modal
              while (modalBody.firstChild) modalBody.removeChild(modalBody.firstChild);

              const duration = call.duration_seconds
                ? Math.floor(call.duration_seconds / 60) + "m " + (call.duration_seconds % 60) + "s"
                : "-";
              const time = call.start_timestamp
                ? new Date(call.start_timestamp).toLocaleString()
                : "N/A";
              const latencyText = call.latency && call.latency.llm
                ? "p50: " + call.latency.llm.p50 + "ms, p99: " + call.latency.llm.p99 + "ms"
                : "-";
              const disconnectReason = call.disconnection_reason
                ? call.disconnection_reason.replace(/_/g, " ")
                : "-";

              // Header
              const header = document.createElement("div");
              header.className = "mb-3";
              const h5 = document.createElement("h5");
              h5.textContent = call.call_type === "web_call" ? "Web Call" : (call.direction === "inbound" ? "Inbound Call" : "Outbound Call");
              const pMeta = document.createElement("p");
              pMeta.className = "text-muted";
              pMeta.textContent = time + " \u2022 " + duration + " \u2022 " + disconnectReason;
              header.appendChild(h5);
              header.appendChild(pMeta);
              modalBody.appendChild(header);

              // Stats row
              const statsRow = document.createElement("div");
              statsRow.className = "row mb-3";
              const stats = [
                { value: String(call.tool_count), label: "Tools Used", bg: "primary" },
                { value: duration, label: "Duration", bg: "info" },
                { value: latencyText, label: "LLM Latency", bg: "success" },
              ];
              stats.forEach((stat) => {
                const col = document.createElement("div");
                col.className = "col-4";
                const card = document.createElement("div");
                card.className = "card bg-" + stat.bg + " bg-opacity-10";
                const body = document.createElement("div");
                body.className = "card-body text-center";
                const val = document.createElement(stat.bg === "success" ? "h5" : "h3");
                val.className = stat.bg === "success" ? "mb-0" : "";
                val.textContent = stat.value;
                const lbl = document.createElement("small");
                lbl.textContent = stat.label;
                body.appendChild(val);
                body.appendChild(lbl);
                card.appendChild(body);
                col.appendChild(card);
                statsRow.appendChild(col);
              });
              modalBody.appendChild(statsRow);

              // Summary
              if (call.summary) {
                const sumH6 = document.createElement("h6");
                sumH6.textContent = "Summary";
                const sumP = document.createElement("p");
                sumP.textContent = call.summary;
                modalBody.appendChild(sumH6);
                modalBody.appendChild(sumP);
              }

              // Tool calls
              const toolH6 = document.createElement("h6");
              toolH6.textContent = "Tool Calls";
              modalBody.appendChild(toolH6);
              const toolDiv = document.createElement("div");
              toolDiv.className = "mb-3";
              if (call.tool_calls && call.tool_calls.length > 0) {
                call.tool_calls.forEach((tc) => {
                  const badge = document.createElement("span");
                  badge.className = "badge bg-info bg-opacity-10 text-info me-1 mb-1";
                  badge.textContent = tc.name || tc.function_name || "unknown";
                  toolDiv.appendChild(badge);
                });
              } else {
                toolDiv.textContent = "No tools used";
                toolDiv.className += " text-muted";
              }
              modalBody.appendChild(toolDiv);

              // Transcript
              const txH6 = document.createElement("h6");
              txH6.textContent = "Transcript";
              modalBody.appendChild(txH6);
              const txCard = document.createElement("div");
              txCard.className = "card bg-dark";
              const txBody = document.createElement("div");
              txBody.className = "card-body";
              txBody.style.maxHeight = "400px";
              txBody.style.overflowY = "auto";
              txBody.style.fontFamily = "monospace";
              txBody.style.fontSize = "0.9em";
              if (call.transcript) {
                call.transcript.split("\n").filter((l) => l.trim()).forEach((line) => {
                  const p = document.createElement("p");
                  if (line.startsWith("Agent:")) {
                    const strong = document.createElement("strong");
                    strong.className = "text-info";
                    strong.textContent = "Agent:";
                    p.appendChild(strong);
                    p.append(" " + line.slice(6).trim());
                  } else if (line.startsWith("User:")) {
                    const strong = document.createElement("strong");
                    strong.className = "text-warning";
                    strong.textContent = "User:";
                    p.appendChild(strong);
                    p.append(" " + line.slice(5).trim());
                  } else {
                    p.textContent = line;
                  }
                  txBody.appendChild(p);
                });
              } else {
                const noTx = document.createElement("p");
                noTx.className = "text-muted";
                noTx.textContent = "No transcript available";
                txBody.appendChild(noTx);
              }
              txCard.appendChild(txBody);
              modalBody.appendChild(txCard);

              // Recording link
              if (call.recording_url) {
                const recDiv = document.createElement("div");
                recDiv.className = "mt-3 text-end";
                const recLink = document.createElement("a");
                recLink.href = call.recording_url;
                recLink.target = "_blank";
                recLink.className = "btn btn-outline-success";
                const recIcon = document.createElement("i");
                recIcon.className = "bi bi-play-fill";
                recLink.appendChild(recIcon);
                recLink.append(" Listen to Recording");
                recDiv.appendChild(recLink);
                modalBody.appendChild(recDiv);
              }

              document.getElementById("callDetailTitle").textContent =
                call.call_type === "web_call" ? "Web Call Details" : "Call " + (call.from_number || "Unknown");

              if (!callDetailModal) {
                callDetailModal = new bootstrap.Modal(
                  document.getElementById("callDetailModal"),
                );
              }
              callDetailModal.show();
            }

            async function loadSettings() {
              try {
                const resp = await fetch("/api/gigi/settings");
                const data = await resp.json();
                if (data.success && data.settings) {
                  const s = data.settings;
                  document.getElementById("setting-mode").value = s.mode || "after_hours";
                  document.getElementById("setting-hours-start").value = s.hours_start || "08:00";
                  document.getElementById("setting-hours-end").value = s.hours_end || "17:00";
                  document.getElementById("setting-transfer-phone").value = s.transfer_phone || "";
                  document.getElementById("setting-log-level").value = s.log_level || "INFO";
                  document.getElementById("setting-wellsky-sync").checked = !!s.wellsky_sync;
                  document.getElementById("setting-auto-sms").checked = !!s.auto_sms;
                }
              } catch (err) {
                console.error("Failed to load settings:", err);
              }
            }
            {% if active_tab == 'settings' %}
            loadSettings();
            {% endif %}

            async function saveSettings() {
              const btn = document.querySelector('button[onclick="saveSettings()"]');
              btn.disabled = true;
              btn.textContent = "Saving...";

              const settings = {
                mode: document.getElementById("setting-mode").value,
                hours_start: document.getElementById("setting-hours-start").value,
                hours_end: document.getElementById("setting-hours-end").value,
                transfer_phone: document.getElementById("setting-transfer-phone")
                  .value,
                log_level: document.getElementById("setting-log-level").value,
                wellsky_sync: document.getElementById("setting-wellsky-sync").checked,
                auto_sms: document.getElementById("setting-auto-sms").checked,
              };

              try {
                const resp = await fetch("/api/gigi/settings", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(settings),
                });
                const data = await resp.json();
                if (data.success) {
                  btn.textContent = "Saved!";
                  setTimeout(() => { btn.textContent = "Save Changes"; }, 2000);
                } else {
                  alert("Failed to save: " + (data.message || "Unknown error"));
                  btn.textContent = "Save Changes";
                }
              } catch (err) {
                alert("Failed to update settings");
                btn.textContent = "Save Changes";
              } finally {
                btn.disabled = false;
              }
            }

            function resetGigi() {
              if (
                confirm("This will restart the Gigi voice service. Active calls will be dropped. Continue?")
              ) {
                fetch("/api/gigi/control", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ command: "stop" }),
                }).then(() => {
                  setTimeout(() => {
                    fetch("/api/gigi/control", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ command: "go" }),
                    }).then(() => {
                      alert("Gigi has been restarted.");
                    });
                  }, 2000);
                }).catch(() => alert("Restart failed."));
              }
            }

      {% if active_tab == 'learning' %}
      (async function loadLearning() {
          // Load scorecard
          try {
              const resp = await fetch('/api/gigi/learning/stats');
              const data = await resp.json();
              if (data.success) {
                  const channels = data.by_channel || data.channels || {};
                  for (const ch of ['telegram', 'sms', 'voice', 'dm']) {
                      const today = channels[ch]?.today || {};
                      const score = today.avg_score || '\u2014';
                      const count = today.count || 0;
                      const scoreEl = document.getElementById('score-' + ch);
                      const countEl = document.getElementById('count-' + ch);
                      if (scoreEl) {
                          scoreEl.textContent = score;
                          if (score !== '\u2014') {
                              scoreEl.style.color = parseFloat(score) >= 4 ? '#22c55e' : parseFloat(score) >= 3 ? '#eab308' : '#ef4444';
                          }
                      }
                      if (countEl) countEl.textContent = count;
                  }
                  // SMS learning stats
                  const sms = data.sms_learning || {};
                  const setTextById = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val ?? '\u2014'; };
                  setTextById('sms-total-drafts', sms.total_drafts);
                  setTextById('sms-paired', sms.paired);
                  setTextById('sms-corrections', sms.corrections_created);
                  setTextById('sms-avg-diff', sms.avg_difference_score);
                  setTextById('sms-active-memories', sms.active_learning_memories);
              }
          } catch (e) { console.error('Failed to load learning stats', e); }

          // Load flagged responses
          try {
              const resp = await fetch('/api/gigi/learning/flagged?limit=25');
              const data = await resp.json();
              const body = document.getElementById('flagged-table-body');
              const badge = document.getElementById('flagged-count-badge');
              const flagged = data.flagged || [];
              if (badge) badge.textContent = flagged.length + ' flagged';
              if (body) {
                  if (flagged.length > 0) {
                      // Build table rows using safe DOM methods
                      body.textContent = '';
                      flagged.forEach(function(f) {
                          const tr = document.createElement('tr');
                          const tdTime = document.createElement('td');
                          tdTime.className = 'small';
                          tdTime.textContent = new Date(f.evaluated_at).toLocaleString();
                          const tdChannel = document.createElement('td');
                          const chBadge = document.createElement('span');
                          chBadge.className = 'badge bg-secondary';
                          chBadge.textContent = f.channel;
                          tdChannel.appendChild(chBadge);
                          const tdMsg = document.createElement('td');
                          tdMsg.className = 'small';
                          tdMsg.textContent = (f.user_message || '').substring(0, 80) + ((f.user_message || '').length > 80 ? '...' : '');
                          const tdScore = document.createElement('td');
                          tdScore.className = 'fw-bold ' + (parseFloat(f.overall_score) < 2 ? 'text-danger' : 'text-warning');
                          tdScore.textContent = f.overall_score ?? '\u2014';
                          const tdReason = document.createElement('td');
                          tdReason.className = 'small text-secondary';
                          tdReason.textContent = f.flag_reason || '';
                          tr.appendChild(tdTime);
                          tr.appendChild(tdChannel);
                          tr.appendChild(tdMsg);
                          tr.appendChild(tdScore);
                          tr.appendChild(tdReason);
                          body.appendChild(tr);
                      });
                  } else {
                      body.textContent = '';
                      const tr = document.createElement('tr');
                      const td = document.createElement('td');
                      td.colSpan = 5;
                      td.className = 'text-center py-4 text-success';
                      td.textContent = 'No flagged responses';
                      tr.appendChild(td);
                      body.appendChild(tr);
                  }
              }
          } catch (e) { console.error('Failed to load flagged responses', e); }
      })();
      {% endif %}
    </script>
  </body>
</html>
