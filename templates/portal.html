{% extends "shared_shell.html" %}

{% block head %}
    <style>
        .tools-layout {
            display: grid; 
            grid-template-columns: 1fr 320px; 
            gap: 24px; 
            align-items: start;
        }
        @media (max-width: 1024px) {
            .tools-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div id="toolsView" class="tools-layout">
        <div>
            <h2 style="font-size: 18px; font-weight: 600; color: #94a3b8; margin-bottom: 16px;">Apps & Tools</h2>
            <div class="tools-grid" id="toolsGrid">
                <!-- Tools will be loaded here -->
            </div>
        </div>
        
        <!-- Activity Feed Widget -->
        <div class="activity-feed-widget" style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; position: sticky; top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 16px; font-weight: 600; color: #f1f5f9; display: flex; align-items: center; gap: 8px;">
                    <span>‚ö°</span> Company Pulse
                </h3>
                <span style="font-size: 12px; color: #64748b; background: #0f172a; padding: 2px 8px; border-radius: 12px; border: 1px solid #334155;">Live</span>
            </div>
            <div id="activityFeedList" style="display: flex; flex-direction: column; gap: 0;">
                <!-- Items injected here -->
                <div style="color: #64748b; font-size: 13px; text-align: center; padding: 20px;">
                    <div style="margin-bottom: 8px;">üì°</div>
                    Listening for events...
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics View -->
    <div id="analyticsView" style="display: none;">
        <div class="tools-list">
            <h2 style="color: #f1f5f9; font-size: 20px; margin-bottom: 24px;">Analytics</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
                <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px;">
                    <div style="color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Total Sessions</div>
                    <div id="totalSessions" style="color: #f1f5f9; font-size: 32px; font-weight: 700;">-</div>
                </div>
                <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px;">
                    <div style="color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Total Clicks</div>
                    <div id="totalClicks" style="color: #f1f5f9; font-size: 32px; font-weight: 700;">-</div>
                </div>
                <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px;">
                    <div style="color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Active Users</div>
                    <div id="activeUsers" style="color: #f1f5f9; font-size: 32px; font-weight: 700;">-</div>
                </div>
            </div>

            <!-- Table sections remain same -->
            <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                <h3 style="color: #f1f5f9; font-size: 18px; margin-bottom: 20px;">Recent Sessions</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #334155;">
                                <th style="padding: 12px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase;">User</th>
                                <th style="padding: 12px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Login Time</th>
                                <th style="padding: 12px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Duration</th>
                                <th style="padding: 12px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTableBody">
                            <tr><td colspan="4" style="padding: 20px; text-align: center; color: #94a3b8;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 24px;">
                <h3 style="color: #f1f5f9; font-size: 18px; margin-bottom: 20px;">Tool Clicks</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #334155;">
                                <th style="padding: 12px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase;">User</th>
                                <th style="padding: 12px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Tool</th>
                                <th style="padding: 12px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase;">Time</th>
                            </tr>
                        </thead>
                        <tbody id="clicksTableBody">
                            <tr><td colspan="3" style="padding: 20px; text-align: center; color: #94a3b8;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin View -->
    <div id="adminView" style="display: none;">
        <div class="tools-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="color: #f1f5f9; font-size: 20px;">Manage Tools</h2>
                <button class="btn" onclick="showAddToolModal()">+ Add Tool</button>
            </div>
            <div id="toolsList">
                <!-- Tools list will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modals (Add/Edit Tool, Weather, AI Tools, Joke) -->
    <div id="toolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Tool</h2>
                <button class="modal-close" onclick="closeToolModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="toolForm">
                    <input type="hidden" id="toolId" value="">
                    <div class="form-group">
                        <label for="toolName">Tool Name *</label>
                        <input type="text" id="toolName" required>
                    </div>
                    <div class="form-group">
                        <label for="toolUrl">URL *</label>
                        <input type="url" id="toolUrl" required>
                    </div>
                    <div class="form-group">
                        <label for="toolIcon">Icon (Emoji or URL)</label>
                        <input type="text" id="toolIcon" placeholder="üîó">
                    </div>
                    <div class="form-group">
                        <label for="toolDescription">Description</label>
                        <textarea id="toolDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="toolCategory">Category</label>
                        <input type="text" id="toolCategory" placeholder="e.g., Analytics, Sales">
                    </div>
                    <div class="form-group">
                        <label for="toolDisplayOrder">Display Order</label>
                        <input type="number" id="toolDisplayOrder" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeToolModal()">Cancel</button>
                <button class="btn btn-danger" id="deleteBtn" style="display: none;" onclick="deleteTool()">Delete</button>
                <button class="btn" onclick="saveTool()">Save</button>
            </div>
        </div>
    </div>

    <!-- Joke of the Day Modal -->
    <div id="jokeModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üòÑ Joke of the Day</h2>
                <button class="modal-close" onclick="closeJokeModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 40px 24px;">
                <div id="jokeContent" style="min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üòÑ</div>
                    <div style="color: #94a3b8;">Loading joke...</div>
                </div>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn" onclick="getNewJoke()">Get Another Joke</button>
                <button class="btn btn-secondary" onclick="closeJokeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Weather Modal -->
    <div id="weatherModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Weather</h2>
                <button class="modal-close" onclick="closeWeatherModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <input type="text" id="weatherSearch" placeholder="Enter city or zip code" 
                               style="flex: 1; padding: 10px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #f1f5f9; font-size: 14px;"
                               onkeypress="if(event.key === 'Enter') searchWeather()">
                        <button class="btn" onclick="searchWeather()" style="white-space: nowrap;">Search</button>
                        <button class="btn btn-secondary" onclick="getCurrentLocationWeather()" style="white-space: nowrap;">üìç My Location</button>
                    </div>
                </div>
                <div id="weatherContent" style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üå§Ô∏è</div>
                    <div style="color: #94a3b8;">Click "My Location" or search for a city</div>
                </div>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeWeatherModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- AI Tools Modal -->
    <div id="aiToolsModal" class="modal">
        <div class="modal-content" style="max-width: 640px;">
            <div class="modal-header">
                <h2>AI Toolbox</h2>
                <button class="modal-close" onclick="closeAIToolsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #94a3b8; margin-bottom: 20px;">
                    Pick an assistant to open in a new tab. Use the portal sidebar to jump back anytime.
                </p>
                <div class="ai-tools-modal-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <a href="https://chatgpt.com/" target="_blank" rel="noopener noreferrer" class="ai-tools-modal-card" style="background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 16px; text-decoration: none; color: inherit; display: block;" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#334155'">
                        <div style="font-size: 24px; margin-bottom: 8px;">üí¨</div>
                        <strong style="display: block; color: #f1f5f9;">ChatGPT</strong>
                        <small style="color: #94a3b8;">OpenAI conversational assistant</small>
                    </a>
                    <a href="https://gemini.google.com/app" target="_blank" rel="noopener noreferrer" class="ai-tools-modal-card" style="background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 16px; text-decoration: none; color: inherit; display: block;" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#334155'">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚ú®</div>
                        <strong style="display: block; color: #f1f5f9;">Gemini</strong>
                        <small style="color: #94a3b8;">Google multimodal AI workspace</small>
                    </a>
                    <a href="https://claude.ai/new" target="_blank" rel="noopener noreferrer" class="ai-tools-modal-card" style="background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 16px; text-decoration: none; color: inherit; display: block;" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#334155'">
                        <div style="font-size: 24px; margin-bottom: 8px;">üß†</div>
                        <strong style="display: block; color: #f1f5f9;">Claude</strong>
                        <small style="color: #94a3b8;">Anthropic assistant for long docs</small>
                    </a>
                    <a href="https://grok.com/" target="_blank" rel="noopener noreferrer" class="ai-tools-modal-card" style="background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 16px; text-decoration: none; color: inherit; display: block;" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#334155'">
                        <div style="font-size: 24px; margin-bottom: 8px;">üöÄ</div>
                        <strong style="display: block; color: #f1f5f9;">Grok</strong>
                        <small style="color: #94a3b8;">xAI real-time Grok answers</small>
                    </a>
                </div>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeAIToolsModal()">Close</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        let currentTools = [];
        let isAdmin = false;

        function showDashboard() {
            document.getElementById('toolsView').style.display = 'grid';
            document.getElementById('analyticsView').style.display = 'none';
            document.getElementById('adminView').style.display = 'none';
        }

        function showAnalytics() {
            document.getElementById('toolsView').style.display = 'none';
            document.getElementById('analyticsView').style.display = 'block';
            document.getElementById('adminView').style.display = 'none';
            loadAnalytics();
        }

        function showAdminView() {
            document.getElementById('toolsView').style.display = 'none';
            document.getElementById('analyticsView').style.display = 'none';
            document.getElementById('adminView').style.display = 'block';
            renderToolsList();
        }

        async function loadTools() {
            try {
                const response = await fetch('/api/tools?t=' + new Date().getTime());
                const data = await response.json();
                if (data.success) {
                    currentTools = data.tools || [];
                    renderToolsGrid();
                }
            } catch (error) { console.error('Error loading tools:', error); }
        }

        function renderToolsGrid() {
            const grid = document.getElementById('toolsGrid');
            if (!grid) return;
            grid.innerHTML = currentTools.map(tool => {
                // Handling for special cards
                if (tool.name === "AI Tools" && tool.url === "#ai-tools-dropdown") {
                    return `
                        <div class="tool-card ai-tools-card" onclick="openAIToolsModal(); trackToolClick(${tool.id}, '${tool.name}', '${tool.url}'); return false;" style="cursor: pointer;">
                            <div class="tool-icon">${tool.icon || 'ü§ñ'}</div>
                            <div class="tool-name">${tool.name}</div>
                            <div style="font-size: 12px; color: #94a3b8;">Quick launcher</div>
                        </div>
                    `;
                }
                return `
                    <a href="${tool.url}" class="tool-card" target="_blank" rel="noopener noreferrer" onclick="trackToolClick(${tool.id}, '${tool.name}', '${tool.url}')">
                        <div class="tool-icon">${tool.icon || 'üîó'}</div>
                        <div class="tool-name">${tool.name}</div>
                        ${tool.description ? `<div class="tool-description" style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${tool.description}</div>` : ''}
                    </a>
                `;
            }).join('');
        }

        async function trackToolClick(toolId, toolName, toolUrl) {
            try {
                await fetch('/api/analytics/track-click', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tool_id: toolId, tool_name: toolName, tool_url: toolUrl })
                });
            } catch (e) {}
        }

        // Add stubs for modals
        function openAIToolsModal() { document.getElementById('aiToolsModal').style.display = 'flex'; }
        function closeAIToolsModal() { document.getElementById('aiToolsModal').style.display = 'none'; }
        function closeToolModal() { document.getElementById('toolModal').style.display = 'none'; }
        function closeJokeModal() { document.getElementById('jokeModal').style.display = 'none'; }
        function closeWeatherModal() { document.getElementById('weatherModal').style.display = 'none'; }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTools();
            loadActivityFeed();
            
            // Check for view param in URL
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            if (view === 'analytics') showAnalytics();
            else if (view === 'admin') showAdminView();
        });

        // Placeholder for analytics loading
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics/summary');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalSessions').textContent = data.summary.total_sessions;
                    document.getElementById('totalClicks').textContent = data.summary.total_clicks;
                    document.getElementById('activeUsers').textContent = data.summary.active_users;
                }
            } catch (e) {}
        }
    </script>
{% endblock %}