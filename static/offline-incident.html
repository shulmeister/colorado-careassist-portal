<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<link rel="manifest" href="/static/incident-manifest.json">
<link rel="apple-touch-icon" href="/static/incident-icon-192.svg">
<title>CCA Incident Report</title>
<style>
:root { --bg:#0f172a; --card:#1e293b; --border:#334155; --text:#f1f5f9; --muted:#94a3b8; --accent:#3b82f6; --green:#22c55e; --red:#ef4444; --orange:#f97316; --yellow:#eab308; }
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:80px}
.header{background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
.header h1{font-size:16px;font-weight:600}
.status{font-size:11px;padding:3px 8px;border-radius:10px;font-weight:600}
.status.offline{background:rgba(249,115,22,.15);color:var(--orange)}
.status.online{background:rgba(34,197,94,.15);color:var(--green)}
.container{max-width:800px;margin:0 auto;padding:16px 12px}
.nav{display:flex;gap:0;margin-bottom:16px;border:1px solid var(--border);border-radius:10px;overflow:hidden;flex-wrap:wrap}
.nav button{flex:1;min-width:80px;padding:10px 4px;background:0 0;border:none;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
.nav button.active{background:var(--accent);color:#fff}
.tab{display:none}.tab.active{display:block}
.section{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px}
.section-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--accent);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.section-title.green{color:var(--green)}
.section-title.orange{color:var(--orange)}
.section-title.yellow{color:var(--yellow)}
.row{display:grid;gap:10px;margin-bottom:10px}
.c2{grid-template-columns:1fr 1fr}.c3{grid-template-columns:1fr 1fr 1fr}.c4{grid-template-columns:1fr 1fr 1fr 1fr}
@media(max-width:600px){.c2,.c3,.c4{grid-template-columns:1fr}}
.fg{display:flex;flex-direction:column}
.fg label{font-size:10px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:3px}
.fg input,.fg select,.fg textarea{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:8px 10px;font-size:14px;font-family:inherit;transition:border .2s}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--accent)}
.fg textarea{resize:vertical;min-height:60px}
.fg select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%2394a3b8' d='M5 7L0 2h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.chk-row{display:flex;flex-wrap:wrap;gap:14px;margin-bottom:10px}
.chk{display:flex;align-items:center;gap:5px}
.chk input[type=checkbox],.chk input[type=radio]{width:16px;height:16px;accent-color:var(--accent)}
.chk label{font-size:13px;color:var(--text);text-transform:none}
.btn{padding:10px 20px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:.2s}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#2563eb}
.btn-green{background:var(--green);color:#fff}
.btn-red{background:transparent;color:var(--red);border:1px solid var(--red)}
.btn-outline{background:transparent;color:var(--muted);border:1px solid var(--border)}
.btn-sm{padding:5px 12px;font-size:11px}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
.saved-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.saved-item .info{flex:1}.saved-item .name{font-weight:600;font-size:14px}.saved-item .meta{font-size:11px;color:var(--muted);margin-top:2px}
.saved-item .btns{display:flex;gap:6px}
.badge{font-size:10px;padding:2px 6px;border-radius:6px;font-weight:600}
.badge.synced{background:rgba(34,197,94,.15);color:var(--green)}
.badge.pending{background:rgba(249,115,22,.15);color:var(--orange)}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;padding:10px 20px;border-radius:8px;font-weight:600;font-size:13px;z-index:1000;display:none;box-shadow:0 4px 20px rgba(0,0,0,.4)}
.install-banner{background:var(--card);border:1px solid var(--accent);border-radius:10px;padding:12px 16px;margin-bottom:16px;display:none;align-items:center;justify-content:space-between}
.install-banner.show{display:flex}
.install-banner span{font-size:13px;color:var(--text)}
.conditional{display:none}
.conditional.open{display:block}
.q-label{font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px}
</style>
</head>
<body>
<div class="header">
    <h1>CCA Incident Report</h1>
    <span class="status" id="conn">...</span>
</div>
<div class="container">
    <div class="install-banner" id="install-banner">
        <span>Install for offline use</span>
        <button class="btn btn-primary btn-sm" id="install-btn">Install</button>
    </div>
    <div class="nav" id="main-nav">
        <button class="active" onclick="go('form')">New</button>
        <button onclick="go('saved')">Saved <span id="cnt"></span></button>
    </div>

    <!-- ========== NEW INCIDENT REPORT TAB ========== -->
    <div class="tab active" id="tab-form">

        <!-- Client / Employee Info -->
        <div class="section">
            <div class="section-title">Client / Employee Info</div>
            <div class="row c2">
                <div class="fg"><label>Client Name *</label><input id="client_name" required></div>
                <div class="fg"><label>Client Birth Date</label><input type="date" id="client_birth_date"></div>
            </div>
            <div class="fg" style="margin-bottom:0">
                <label>Employee Name</label>
                <input id="employee_name" placeholder="Employee involved in the incident">
            </div>
            <input type="hidden" id="client_id" value="">
            <input type="hidden" id="employee_id" value="">
        </div>

        <!-- SECTION 1 — INCIDENT -->
        <div class="section">
            <div class="section-title" style="color:var(--accent)">Section 1 — Incident</div>

            <!-- 1. Date/Time of Incident -->
            <div class="q-label">1. Date and Time of Incident</div>
            <div class="row c2">
                <div class="fg"><label>Date of Incident</label><input type="date" id="incident_date"></div>
                <div class="fg"><label>Time of Incident</label><input type="time" id="incident_time"></div>
            </div>

            <!-- 2. Date/Time Reported -->
            <div class="q-label">2. Date and Time Incident Reported</div>
            <div class="row c2">
                <div class="fg"><label>Date Reported</label><input type="date" id="reported_date"></div>
                <div class="fg"><label>Time Reported</label><input type="time" id="reported_time"></div>
            </div>

            <!-- 3. Incident reported by -->
            <div class="q-label">3. Incident reported by</div>
            <div class="row c2">
                <div class="fg"><label>Name</label><input id="reported_by_name"></div>
                <div class="fg"><label>Role</label><input id="reported_by_role"></div>
            </div>

            <!-- 4. Incident reported to -->
            <div class="q-label">4. Incident reported to</div>
            <div class="row c2">
                <div class="fg"><label>Name</label><input id="reported_to_name"></div>
                <div class="fg"><label>Role</label><input id="reported_to_role"></div>
            </div>

            <!-- 5. Location -->
            <div class="q-label">5. Location of Incident</div>
            <div class="fg" style="margin-bottom:10px">
                <label>Location</label>
                <input id="location" placeholder="Address or description of location">
            </div>

            <!-- 6. Other Individuals involved -->
            <div class="q-label">6. Other Individuals Involved</div>
            <div class="row c2">
                <div class="fg"><label>Name</label><input id="other1_name"></div>
                <div class="fg"><label>Role</label><input id="other1_role"></div>
            </div>
            <div class="row c2">
                <div class="fg"><label>Name</label><input id="other2_name"></div>
                <div class="fg"><label>Role</label><input id="other2_role"></div>
            </div>
            <div class="row c2">
                <div class="fg"><label>Name</label><input id="other3_name"></div>
                <div class="fg"><label>Role</label><input id="other3_role"></div>
            </div>

            <!-- 7. Witness description -->
            <div class="q-label">7. Witness's Description of the Incident</div>
            <div class="fg" style="margin-bottom:10px">
                <label>Description</label>
                <textarea id="witness_description" rows="4" placeholder="Detailed description of what happened..."></textarea>
            </div>

            <!-- 8. Resulted in injury? -->
            <div class="q-label">8. Incident resulted in injury?</div>
            <div class="chk-row">
                <div class="chk"><input type="radio" name="resulted_in_injury" value="Yes" onchange="toggleInjury()"> <label>Yes</label></div>
                <div class="chk"><input type="radio" name="resulted_in_injury" value="No" onchange="toggleInjury()"> <label>No</label></div>
            </div>
            <div id="injury-section" class="conditional">
                <div class="fg"><label>Describe the injury</label><textarea id="injury_description" rows="3" placeholder="Type and extent of injury..."></textarea></div>
            </div>
        </div>

        <!-- SECTION 2 — INVESTIGATION / FINDINGS -->
        <div class="section">
            <div class="section-title orange">Section 2 — Investigation / Findings</div>

            <!-- 9. Supervisor comments -->
            <div class="q-label">9. Supervisor's / Investigator's Comments / Findings</div>
            <div class="fg" style="margin-bottom:10px">
                <label>Comments / Findings</label>
                <textarea id="supervisor_comments" rows="4" placeholder="Investigation findings..."></textarea>
            </div>

            <!-- 10. Was the incident preventable? -->
            <div class="q-label">10. Was the Incident preventable?</div>
            <div class="chk-row">
                <div class="chk"><input type="radio" name="was_preventable" value="Yes" onchange="togglePreventable()"> <label>Yes</label></div>
                <div class="chk"><input type="radio" name="was_preventable" value="No" onchange="togglePreventable()"> <label>No</label></div>
            </div>
            <div id="preventable-section" class="conditional">
                <div class="fg"><label>Suggested Corrective Action(s)</label><textarea id="corrective_actions" rows="3" placeholder="Describe corrective actions to prevent recurrence..."></textarea></div>
            </div>

            <!-- 11. Reported to external agency? -->
            <div class="q-label">11. Incident reported to an external Agency?</div>
            <div class="chk-row">
                <div class="chk"><input type="radio" name="reported_to_external" value="Yes" onchange="toggleExternal()"> <label>Yes</label></div>
                <div class="chk"><input type="radio" name="reported_to_external" value="No" onchange="toggleExternal()"> <label>No</label></div>
            </div>
            <div id="external-section" class="conditional">
                <div class="fg" style="margin-bottom:10px"><label>Name of Agency</label><input id="external_agency_name" placeholder="e.g., CDPHE, APS, etc."></div>
                <div class="row c2">
                    <div class="fg"><label>Reported by (Name)</label><input id="external_reported_by"></div>
                    <div class="fg"><label>Reported by (Role)</label><input id="external_reported_role"></div>
                </div>
            </div>

            <!-- 12. Agency Manager review -->
            <div class="q-label">12. Agency Manager's Review / Comments / Actions</div>
            <div class="fg">
                <label>Manager Review</label>
                <textarea id="manager_review" rows="4" placeholder="Manager's review and any additional actions taken..."></textarea>
            </div>
        </div>

        <!-- Save / Clear buttons -->
        <div class="actions">
            <button class="btn btn-green" onclick="saveIR()">Save Incident Report</button>
            <button class="btn btn-outline" onclick="clearForm()">Clear All</button>
        </div>
    </div>

    <!-- ========== SAVED TAB ========== -->
    <div class="tab" id="tab-saved">
        <div id="saved-list"></div>
        <div class="actions" style="margin-top:12px">
            <button class="btn btn-primary" onclick="syncAll()" id="sync-btn">Sync All to Portal</button>
            <button class="btn btn-outline" onclick="exportAll()">Export JSON</button>
        </div>
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
// === PWA Install ===
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone === true;
let deferredPrompt;
if (!isStandalone) {
    window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; document.getElementById('install-banner').classList.add('show'); });
    document.getElementById('install-btn').addEventListener('click', () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('install-banner').classList.remove('show'); });
    });
}
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/static/incident-sw.js').catch(e => console.warn('SW:', e));

// === Navigation ===
function go(tab) {
    document.querySelectorAll('#main-nav button').forEach((b,i) => b.classList.toggle('active', (i===0&&tab==='form')||(i===1&&tab==='saved')));
    document.getElementById('tab-form').classList.toggle('active', tab==='form');
    document.getElementById('tab-saved').classList.toggle('active', tab==='saved');
    if (tab==='saved') renderSaved();
}

// === Connection ===
function updateConn() { const el=document.getElementById('conn'); if(navigator.onLine){el.textContent='Online';el.className='status online'}else{el.textContent='Offline';el.className='status offline'} }
window.addEventListener('online', updateConn); window.addEventListener('offline', updateConn); updateConn();

// === Toast ===
function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2500); }

// === Conditional Section Toggles ===
function toggleInjury() {
    const val = getRadioVal('resulted_in_injury');
    document.getElementById('injury-section').classList.toggle('open', val==='Yes');
}
function togglePreventable() {
    const val = getRadioVal('was_preventable');
    document.getElementById('preventable-section').classList.toggle('open', val==='Yes');
}
function toggleExternal() {
    const val = getRadioVal('reported_to_external');
    document.getElementById('external-section').classList.toggle('open', val==='Yes');
}
function getRadioVal(name) {
    const el = document.querySelector('input[name="'+name+'"]:checked');
    return el ? el.value : '';
}

// === All Form Fields ===
const INPUTS = [
    'client_name','client_birth_date','employee_name','client_id','employee_id',
    'incident_date','incident_time','reported_date','reported_time',
    'reported_by_name','reported_by_role','reported_to_name','reported_to_role',
    'location',
    'other1_name','other1_role','other2_name','other2_role','other3_name','other3_role',
    'witness_description','injury_description',
    'supervisor_comments','corrective_actions',
    'external_agency_name','external_reported_by','external_reported_role',
    'manager_review'
];
const RADIOS = ['resulted_in_injury','was_preventable','reported_to_external'];

function getData() {
    const d = {};
    INPUTS.forEach(id => { const el=document.getElementById(id); if(el) d[id]=el.value; });
    RADIOS.forEach(name => { const el=document.querySelector('input[name="'+name+'"]:checked'); d[name] = el ? el.value : ''; });
    return d;
}

function setData(d) {
    INPUTS.forEach(id => { const el=document.getElementById(id); if(el && d[id]!==undefined) el.value=d[id]; });
    RADIOS.forEach(name => {
        const val = d[name] || d['radio_'+name];
        if(val) {
            const el=document.querySelector('input[name="'+name+'"][value="'+val+'"]');
            if(el) el.checked=true;
        }
    });
    // Restore conditional section visibility
    toggleInjury();
    togglePreventable();
    toggleExternal();
}

function clearForm() {
    INPUTS.forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
    RADIOS.forEach(name => { document.querySelectorAll('input[name="'+name+'"]').forEach(el => el.checked=false); });
    // Set defaults
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('incident_date').value = today;
    document.getElementById('reported_date').value = today;
    document.getElementById('client_id').value = '';
    document.getElementById('employee_id').value = '';
    // Hide conditional sections
    document.getElementById('injury-section').classList.remove('open');
    document.getElementById('preventable-section').classList.remove('open');
    document.getElementById('external-section').classList.remove('open');
    currentEditId = null;
    clearDraft();
}

// === Storage ===
const STORAGE_KEY = 'cca_incident_reports';
const DRAFT_KEY = 'cca_ir_draft';
function getAll() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch { return []; } }
function saveAllStorage(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); updCnt(); }
function updCnt() { const c=getAll().length; document.getElementById('cnt').textContent = c ? '('+c+')' : ''; }

let currentEditId = null;

// === Auto-save draft to localStorage (every keystroke, debounced) ===
let draftTimer = null;
function saveDraft() {
    clearTimeout(draftTimer);
    draftTimer = setTimeout(() => {
        const d = getData();
        const hasContent = INPUTS.some(id => {
            const el=document.getElementById(id);
            return el && el.value.trim() && id!=='client_id' && id!=='employee_id' && id!=='incident_date' && id!=='reported_date';
        });
        const hasRadio = RADIOS.some(name => d['radio_'+name]);
        if (hasContent || hasRadio || currentEditId) {
            localStorage.setItem(DRAFT_KEY, JSON.stringify({ data: d, editId: currentEditId, ts: Date.now() }));
        }
    }, 500);
}
function clearDraft() { localStorage.removeItem(DRAFT_KEY); }
function loadDraft() {
    try {
        const raw = localStorage.getItem(DRAFT_KEY);
        if (!raw) return false;
        const draft = JSON.parse(raw);
        if (!draft.data) return false;
        setData(draft.data);
        if (draft.editId) currentEditId = draft.editId;
        return true;
    } catch { return false; }
}
// Listen on all form inputs for auto-save
document.addEventListener('input', saveDraft);
document.addEventListener('change', saveDraft);

function saveIR() {
    const d = getData();
    const name = d.client_name || '';
    if (!name.trim()) { alert('Client Name is required.'); return; }

    const list = getAll();
    if (currentEditId) {
        const idx = list.findIndex(a => a.id===currentEditId);
        if (idx>=0) { list[idx].data=d; list[idx].updated_at=new Date().toISOString(); list[idx].synced=false; }
        currentEditId = null;
    } else {
        list.push({ id:'ir_'+Date.now()+'_'+Math.random().toString(36).slice(2,8), data:d, created_at:new Date().toISOString(), updated_at:new Date().toISOString(), synced:false });
    }
    saveAllStorage(list);
    clearDraft();
    showToast('Incident Report saved');
    clearForm();
    // Auto-sync immediately if online
    if (navigator.onLine) setTimeout(autoSync, 300);
}

function renderSaved() {
    const list=getAll(), c=document.getElementById('saved-list');
    if (!list.length) { c.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">No saved incident reports.</div>'; return; }
    c.innerHTML = list.map(a => {
        const name = a.data.client_name || 'Unnamed';
        const date = a.data.incident_date || a.created_at.split('T')[0];
        const badge = a.synced ? '<span class="badge synced">Synced</span>' : '<span class="badge pending">Pending</span>';
        return '<div class="saved-item"><div class="info"><div class="name">'+name+' '+badge+'</div><div class="meta">Incident: '+date+'</div></div><div class="btns"><button class="btn btn-outline btn-sm" onclick="editIR(\''+a.id+'\')">Edit</button><button class="btn btn-red btn-sm" onclick="delIR(\''+a.id+'\')">Del</button></div></div>';
    }).join('');
}

function editIR(id) { const a=getAll().find(x=>x.id===id); if(!a) return; clearForm(); setData(a.data); currentEditId=id; go('form'); showToast('Editing: '+(a.data.client_name||'Report')); }
function delIR(id) { if(!confirm('Delete?')) return; saveAllStorage(getAll().filter(a=>a.id!==id)); renderSaved(); showToast('Deleted'); }

// === Sync ===
let syncing = false;
async function autoSync() {
    if (syncing || !navigator.onLine) return;
    const list = getAll(), pending = list.filter(a => !a.synced);
    if (!pending.length) return;
    syncing = true;
    let ok = 0;
    for (const a of pending) {
        try {
            const r = await fetch('/api/incident-reports/sync', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify(a) });
            if (r.ok) { a.synced = true; ok++; }
        } catch(e) { console.error('Sync fail:', a.id, e); }
    }
    if (ok > 0) { saveAllStorage(list); showToast('Auto-synced '+ok+' report'+(ok>1?'s':'')); }
    syncing = false;
}

async function syncAll() {
    if (!navigator.onLine) { alert('No internet. Will auto-sync when back online.'); return; }
    const list=getAll(), pending=list.filter(a=>!a.synced);
    if (!pending.length) { showToast('All synced'); return; }
    const btn=document.getElementById('sync-btn'); btn.disabled=true; btn.textContent='Syncing...';
    syncing = true;
    let ok=0;
    for (const a of pending) {
        try {
            const r = await fetch('/api/incident-reports/sync', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify(a) });
            if (r.ok) { a.synced=true; ok++; }
        } catch(e) { console.error('Sync fail:', a.id, e); }
    }
    saveAllStorage(list); renderSaved();
    btn.disabled=false; btn.textContent='Sync All to Portal';
    syncing = false;
    showToast('Synced '+ok+'/'+pending.length);
}

// Auto-sync when internet comes back
window.addEventListener('online', () => { updateConn(); setTimeout(autoSync, 1000); });
// Auto-sync every 60 seconds when online
setInterval(() => { if (navigator.onLine) autoSync(); }, 60000);

function exportAll() {
    const list=getAll(); if(!list.length){alert('No incident reports.');return;}
    const b=new Blob([JSON.stringify(list,null,2)],{type:'application/json'});
    const u=URL.createObjectURL(b), a=document.createElement('a');
    a.href=u; a.download='cca-incident-reports-'+new Date().toISOString().split('T')[0]+'.json';
    a.click(); URL.revokeObjectURL(u);
    showToast('Exported '+list.length);
}

// === URL param pre-fill ===
const params = new URLSearchParams(window.location.search);
if (params.get('client')) document.getElementById('client_name').value = decodeURIComponent(params.get('client'));
if (params.get('client_id')) document.getElementById('client_id').value = params.get('client_id');
if (params.get('employee')) document.getElementById('employee_name').value = decodeURIComponent(params.get('employee'));
if (params.get('employee_id')) document.getElementById('employee_id').value = params.get('employee_id');

// === Init ===
updCnt();
// Restore draft if one exists, otherwise set defaults
if (!loadDraft()) {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('incident_date').value = today;
    document.getElementById('reported_date').value = today;
}
// Auto-sync any pending reports on startup
if (navigator.onLine) setTimeout(autoSync, 2000);
</script>
</body>
</html>
